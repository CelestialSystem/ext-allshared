'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require('@babel/polyfill');

const fs = require('fs');

const path = require('path');

const pluginUtil = require(`./pluginUtil`);

const replace = require("replace"); // process.stdin.resume();
// process.on('SIGINT', function () {
//   console.log('Got SIGINT.  Press Control-D to exit.');
// });
// function cleanUpServer(eventType) {
//   console.log(eventType)
//   process.exit();
// }
// [`exit`, `SIGINT`, `SIGUSR1`, `SIGUSR2`, `uncaughtException`, `SIGTERM`].forEach((eventType) => {
//   process.on(eventType, cleanUpServer.bind(null, eventType));
// })


class ExtWebpackPlugin {
  constructor(options) {
    var constructorOutput = pluginUtil._constructor(options);

    this.vars = constructorOutput.vars;
    this.options = constructorOutput.options;
    this.vars.child = null;
    var me = this;
    [`exit`, `SIGINT`, `SIGUSR1`, `SIGUSR2`, `uncaughtException`, `SIGTERM`].forEach(eventType => {
      //process.on(eventType, me.cleanUpServer2.bind(null, eventType));
      process.on(eventType, function (eventType) {
        //console.log(eventType)
        //console.log(me.vars.child)
        if (me.vars.child != null) {
          //console.log(me.vars.child.kill)
          me.vars.child.kill();
        } else {//console.log('child is null')
        }

        process.exit();
      });
    }); //console.log('added')
  }

  apply(compiler) {
    const vars = this.vars;
    const options = this.options;
    const app = this.app;

    if (!compiler.hooks) {
      console.log('not webpack 4');
      return;
    }

    compiler.hooks.thisCompilation.tap(`ext-this-compilation`, compilation => {
      pluginUtil.logh(app, `HOOK thisCompilation`);

      pluginUtil._thisCompilation(compiler, compilation, vars, options);

      if (vars.pluginErrors.length > 0) {
        compilation.errors.push(new Error(vars.pluginErrors.join("")));
        return;
      }
    }); //var cRun = 0;

    compiler.hooks.compilation.tap(`ext-compilation`, compilation => {
      pluginUtil.logh(app, `HOOK compilation`); //if (cRun == 0) {

      pluginUtil._compilation(compiler, compilation, vars, options); //}
      //cRun++;

    });
    compiler.hooks.afterCompile.tap('ext-after-compile', compilation => {
      pluginUtil.logh(app, `HOOK afterCompile`);

      pluginUtil._afterCompile(compiler, compilation, vars, options);
    });
    compiler.hooks.emit.tapAsync(`ext-emit`, (compilation, callback) => {
      pluginUtil.logh(app, `HOOK emit (async)`);

      pluginUtil._emit(compiler, compilation, vars, options, callback);
    });
    compiler.hooks.done.tap(`ext-done`, stats => {
      pluginUtil.logh(app, `HOOK done`);
      this.postBuildProcess(stats.compilation.outputOptions);

      pluginUtil._done(stats, vars, options);
    });
  }

  postBuildProcess(options) {
    /**
       * 1. Read the temp file written by the Cmd plugin to get the app.json configured build path
       * 2. Extract the path as a String, trimmed to the location of the build folder
       * 3. Copy webpack bundle to destination directory
       * 4. Delete the temp file
       */
    const outputPath = options.path;
    const bundleName = options.filename == "[name].js" ? "main.js" : options.filename;
    const tempFilePath = outputPath + 'temp.txt';
    const buildFolder = "build";

    if (fs.existsSync(tempFilePath)) {
      const configProdPath = fs.readFileSync(tempFilePath, "utf8").toString().trim();
      fs.unlinkSync(tempFilePath);
      const trimmedProdPathIndex = configProdPath.indexOf(buildFolder);
      const prodBuildPath = configProdPath.substring(trimmedProdPathIndex);
      const copyBundleDest = path.join(prodBuildPath, bundleName);

      if (fs.existsSync(bundleName)) {
        fs.copyFileSync(bundleName, copyBundleDest); // Due to the race condition between Cmd's processing for production files and the webpack bundling
        // index.html doesn't receive the injected reference to the webpack bundle.

        replace({
          regex: '</body>',
          replacement: '<script type="text/javascript" src="' + bundleName + '"></script></body>',
          paths: [path.join(prodBuildPath, 'index.html')]
        });
      }
    }
  }

}

exports.default = ExtWebpackPlugin;
module.exports = exports.default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbmRleC5qcyJdLCJuYW1lcyI6WyJyZXF1aXJlIiwiZnMiLCJwYXRoIiwicGx1Z2luVXRpbCIsInJlcGxhY2UiLCJFeHRXZWJwYWNrUGx1Z2luIiwiY29uc3RydWN0b3IiLCJvcHRpb25zIiwiY29uc3RydWN0b3JPdXRwdXQiLCJfY29uc3RydWN0b3IiLCJ2YXJzIiwiY2hpbGQiLCJtZSIsImZvckVhY2giLCJldmVudFR5cGUiLCJwcm9jZXNzIiwib24iLCJraWxsIiwiZXhpdCIsImFwcGx5IiwiY29tcGlsZXIiLCJhcHAiLCJob29rcyIsImNvbnNvbGUiLCJsb2ciLCJ0aGlzQ29tcGlsYXRpb24iLCJ0YXAiLCJjb21waWxhdGlvbiIsImxvZ2giLCJfdGhpc0NvbXBpbGF0aW9uIiwicGx1Z2luRXJyb3JzIiwibGVuZ3RoIiwiZXJyb3JzIiwicHVzaCIsIkVycm9yIiwiam9pbiIsIl9jb21waWxhdGlvbiIsImFmdGVyQ29tcGlsZSIsIl9hZnRlckNvbXBpbGUiLCJlbWl0IiwidGFwQXN5bmMiLCJjYWxsYmFjayIsIl9lbWl0IiwiZG9uZSIsInN0YXRzIiwicG9zdEJ1aWxkUHJvY2VzcyIsIm91dHB1dE9wdGlvbnMiLCJfZG9uZSIsIm91dHB1dFBhdGgiLCJidW5kbGVOYW1lIiwiZmlsZW5hbWUiLCJ0ZW1wRmlsZVBhdGgiLCJidWlsZEZvbGRlciIsImV4aXN0c1N5bmMiLCJjb25maWdQcm9kUGF0aCIsInJlYWRGaWxlU3luYyIsInRvU3RyaW5nIiwidHJpbSIsInVubGlua1N5bmMiLCJ0cmltbWVkUHJvZFBhdGhJbmRleCIsImluZGV4T2YiLCJwcm9kQnVpbGRQYXRoIiwic3Vic3RyaW5nIiwiY29weUJ1bmRsZURlc3QiLCJjb3B5RmlsZVN5bmMiLCJyZWdleCIsInJlcGxhY2VtZW50IiwicGF0aHMiXSwibWFwcGluZ3MiOiJBQUNBOzs7Ozs7O0FBQ0FBLE9BQU8sQ0FBQyxpQkFBRCxDQUFQOztBQUNBLE1BQU1DLEVBQUUsR0FBR0QsT0FBTyxD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IGZzID0gcmVxdWlyZSgnZnMnKTtcbmNvbnN0IHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XG5jb25zdCBwbHVnaW5VdGlsID0gcmVxdWlyZShgLi9wbHVnaW5VdGlsYClcbmNvbnN0IHJlcGxhY2UgPSByZXF1aXJlKFwicmVwbGFjZVwiKTtcblxuLy8gcHJvY2Vzcy5zdGRpbi5yZXN1bWUoKTtcbi8vIHByb2Nlc3Mub24oJ1NJR0lOVCcsIGZ1bmN0aW9uICgpIHtcbi8vICAgY29uc29sZS5sb2coJ0dvdCBTSUdJTlQuICBQcmVzcyBDb250cm9sLUQgdG8gZXhpdC4nKTtcbi8vIH0pO1xuLy8gZnVuY3Rpb24gY2xlYW5VcFNlcnZlcihldmVudFR5cGUpIHtcbi8vICAgY29uc29sZS5sb2coZXZlbnRUeXBlKVxuLy8gICBwcm9jZXNzLmV4aXQoKTtcbi8vIH1cbi8vIFtgZXhpdGAsIGBTSUdJTlRgLCBgU0lHVVNSMWAsIGBTSUdVU1IyYCwgYHVuY2F1Z2h0RXhjZXB0aW9uYCwgYFNJR1RFUk1gXS5mb3JFYWNoKChldmVudFR5cGUpID0+IHtcbi8vICAgcHJvY2Vzcy5vbihldmVudFR5cGUsIGNsZWFuVXBTZXJ2ZXIuYmluZChudWxsLCBldmVudFR5cGUpKTtcbi8vIH0pXG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIEV4dFdlYnBhY2tQbHVnaW4ge1xuXG4gIGNvbnN0cnVjdG9yKG9wdGlvbnMpIHtcbiAgICB2YXIgY29uc3RydWN0b3JPdXRwdXQgPSBwbHVnaW5VdGlsLl9jb25zdHJ1Y3RvcihvcHRpb25zKVxuICAgIHRoaXMudmFycyA9IGNvbnN0cnVjdG9yT3V0cHV0LnZhcnNcbiAgICB0aGlzLm9wdGlvbnMgPSBjb25zdHJ1Y3Rvck91dHB1dC5vcHRpb25zXG5cbiAgICB0aGlzLnZhcnMuY2hpbGQgPSBudWxsO1xuICAgIHZhciBtZSA9IHRoaXM7XG5cbiAgICBbYGV4aXRgLCBgU0lHSU5UYCwgYFNJR1VTUjFgLCBgU0lHVVNSMmAsIGB1bmNhdWdodEV4Y2VwdGlvbmAsIGBTSUdURVJNYF0uZm9yRWFjaCgoZXZlbnRUeXBlKSA9PiB7XG4gICAgICAvL3Byb2Nlc3Mub24oZXZlbnRUeXBlLCBtZS5jbGVhblVwU2VydmVyMi5iaW5kKG51bGwsIGV2ZW50VHlwZSkpO1xuICAgICAgcHJvY2Vzcy5vbihldmVudFR5cGUsIGZ1bmN0aW9uKGV2ZW50VHlwZSl7XG4gICAgICAgIC8vY29uc29sZS5sb2coZXZlbnRUeXBlKVxuICAgICAgICAvL2NvbnNvbGUubG9nKG1lLnZhcnMuY2hpbGQpXG4gICAgICAgIGlmIChtZS52YXJzLmNoaWxkICE9IG51bGwpIHtcbiAgICAgICAgICAvL2NvbnNvbGUubG9nKG1lLnZhcnMuY2hpbGQua2lsbClcbiAgICAgICAgICBtZS52YXJzLmNoaWxkLmtpbGwoKTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAvL2NvbnNvbGUubG9nKCdjaGlsZCBpcyBudWxsJylcbiAgICAgICAgfVxuICAgICAgICBwcm9jZXNzLmV4aXQoKTtcbiAgICAgIH0pO1xuICAgIH0pXG4gICAgLy9jb25zb2xlLmxvZygnYWRkZWQnKVxuICB9XG5cbiAgYXBwbHkoY29tcGlsZXIpIHtcbiAgICBjb25zdCB2YXJzID0gdGhpcy52YXJzXG4gICAgY29uc3Qgb3B0aW9ucyA9IHRoaXMub3B0aW9uc1xuICAgIGNvbnN0IGFwcCA9IHRoaXMuYXBwXG5cbiAgICBpZiAoIWNvbXBpbGVyLmhvb2tzKSB7XG4gICAgICBjb25zb2xlLmxvZygnbm90IHdlYnBhY2sgNCcpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbXBpbGVyLmhvb2tzLnRoaXNDb21waWxhdGlvbi50YXAoYGV4dC10aGlzLWNvbXBpbGF0aW9uYCwgKGNvbXBpbGF0aW9uKSA9PiB7XG4gICAgICBwbHVnaW5VdGlsLmxvZ2goYXBwLCBgSE9PSyB0aGlzQ29tcGlsYXRpb25gKVxuICAgICAgcGx1Z2luVXRpbC5fdGhpc0NvbXBpbGF0aW9uKGNvbXBpbGVyLCBjb21waWxhdGlvbiwgdmFycywgb3B0aW9ucylcblxuICAgICAgaWYgKHZhcnMucGx1Z2luRXJyb3JzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgY29tcGlsYXRpb24uZXJyb3JzLnB1c2goIG5ldyBFcnJvcih2YXJzLnBsdWdpbkVycm9ycy5qb2luKFwiXCIpKSApXG4gICAgICAgIHJldHVyblxuICAgICAgfVxuICAgIH0pXG5cbiAgICAvL3ZhciBjUnVuID0gMDtcbiAgICBjb21waWxlci5ob29rcy5jb21waWxhdGlvbi50YXAoYGV4dC1jb21waWxhdGlvbmAsIChjb21waWxhdGlvbikgPT4ge1xuICAgICAgcGx1Z2luVXRpbC5sb2doKGFwcCwgYEhPT0sgY29tcGlsYXRpb25gKVxuICAgICAgLy9pZiAoY1J1biA9PSAwKSB7XG4gICAgICAgIHBsdWdpblV0aWwuX2NvbXBpbGF0aW9uKGNvbXBpbGVyLCBjb21waWxhdGlvbiwgdmFycywgb3B0aW9ucyk7XG4gICAgICAvL31cbiAgICAgIC8vY1J1bisrO1xuICAgIH0pXG5cbiAgICBjb21waWxlci5ob29rcy5hZnRlckNvbXBpbGUudGFwKCdleHQtYWZ0ZXItY29tcGlsZScsIChjb21waWxhdGlvbikgPT4ge1xuICAgICAgcGx1Z2luVXRpbC5sb2doKGFwcCwgYEhPT0sgYWZ0ZXJDb21waWxlYClcbiAgICAgIHBsdWdpblV0aWwuX2FmdGVyQ29tcGlsZShjb21waWxlciwgY29tcGlsYXRpb24sIHZhcnMsIG9wdGlvbnMpXG4gICAgfSlcblxuICAgIGNvbXBpbGVyLmhvb2tzLmVtaXQudGFwQXN5bmMoYGV4dC1lbWl0YCwgKGNvbXBpbGF0aW9uLCBjYWxsYmFjaykgPT4ge1xuICAgICAgcGx1Z2luVXRpbC5sb2doKGFwcCwgYEhPT0sgZW1pdCAoYXN5bmMpYClcblxuXG5cblxuXG5cbiAgICAgIHBsdWdpblV0aWwuX2VtaXQoY29tcGlsZXIsIGNvbXBpbGF0aW9uLCB2YXJzLCBvcHRpb25zLCBjYWxsYmFjaylcbiAgICB9KVxuXG4gICAgY29tcGlsZXIuaG9va3MuZG9uZS50YXAoYGV4dC1kb25lYCwgKHN0YXRzKSA9PiB7XG4gICAgICBwbHVnaW5VdGlsLmxvZ2goYXBwLCBgSE9PSyBkb25lYClcbiAgICAgIHRoaXMucG9zdEJ1aWxkUHJvY2VzcyhzdGF0cy5jb21waWxhdGlvbi5vdXRwdXRPcHRpb25zKVxuICAgICAgcGx1Z2luVXRpbC5fZG9uZShzdGF0cywgdmFycywgb3B0aW9ucylcbiAgICB9KVxuICB9XG5cbiAgcG9zdEJ1aWxkUHJvY2VzcyhvcHRpb25zKSB7XG4gICAgLyoqXG4gICAgICAgKiAxLiBSZWFkIHRoZSB0ZW1wIGZpbGUgd3JpdHRlbiBieSB0aGUgQ21kIHBsdWdpbiB0byBnZXQgdGhlIGFwcC5qc29uIGNvbmZpZ3VyZWQgYnVpbGQgcGF0aFxuICAgICAgICogMi4gRXh0cmFjdCB0aGUgcGF0aCBhcyBhIFN0cmluZywgdHJpbW1lZCB0byB0aGUgbG9jYXRpb24gb2YgdGhlIGJ1aWxkIGZvbGRlclxuICAgICAgICogMy4gQ29weSB3ZWJwYWNrIGJ1bmRsZSB0byBkZXN0aW5hdGlvbiBkaXJlY3RvcnlcbiAgICAgICAqIDQuIERlbGV0ZSB0aGUgdGVtcCBmaWxlXG4gICAgICAgKi9cbiAgICAgIGNvbnN0IG91dHB1dFBhdGggPSBvcHRpb25zLnBhdGg7XG4gICAgICBjb25zdCBidW5kbGVOYW1lID0gKChvcHRpb25zLmZpbGVuYW1lID09IFwiW25hbWVdLmpzXCIpID8gXCJtYWluLmpzXCIgOiBvcHRpb25zLmZpbGVuYW1lKTtcbiAgICAgIGNvbnN0IHRlbXBGaWxlUGF0aCA9IG91dHB1dFBhdGgrJ3RlbXAudHh0JztcbiAgICAgIGNvbnN0IGJ1aWxkRm9sZGVyID0gXCJidWlsZFwiXG5cbiAgICAgIGlmIChmcy5leGlzdHNTeW5jKHRlbXBGaWxlUGF0aCkpIHtcbiAgICAgICAgY29uc3QgY29uZmlnUHJvZFBhdGggPSBmcy5yZWFkRmlsZVN5bmModGVtcEZpbGVQYXRoLCBcInV0ZjhcIikudG9TdHJpbmcoKS50cmltKCk7XG4gICAgICAgIGZzLnVubGlua1N5bmModGVtcEZpbGVQYXRoKTtcbiAgICAgICAgY29uc3QgdHJpbW1lZFByb2RQYXRoSW5kZXggPSBjb25maWdQcm9kUGF0aC5pbmRleE9mKGJ1aWxkRm9sZGVyKTtcbiAgICAgICAgY29uc3QgcHJvZEJ1aWxkUGF0aCA9IGNvbmZpZ1Byb2RQYXRoLnN1YnN0cmluZyh0cmltbWVkUHJvZFBhdGhJbmRleClcbiAgICAgICAgY29uc3QgY29weUJ1bmRsZURlc3QgPSBwYXRoLmpvaW4ocHJvZEJ1aWxkUGF0aCwgYnVuZGxlTmFtZSk7XG4gICAgICAgIGlmIChmcy5leGlzdHNTeW5jKGJ1bmRsZU5hbWUpKSB7XG4gICAgICAgICAgZnMuY29weUZpbGVTeW5jKGJ1bmRsZU5hbWUsIGNvcHlCdW5kbGVEZXN0KTtcblxuICAgICAgICAgIC8vIER1ZSB0byB0aGUgcmFjZSBjb25kaXRpb24gYmV0d2VlbiBDbWQncyBwcm9jZXNzaW5nIGZvciBwcm9kdWN0aW9uIGZpbGVzIGFuZCB0aGUgd2VicGFjayBidW5kbGluZ1xuICAgICAgICAgIC8vIGluZGV4Lmh0bWwgZG9lc24ndCByZWNlaXZlIHRoZSBpbmplY3RlZCByZWZlcmVuY2UgdG8gdGhlIHdlYnBhY2sgYnVuZGxlLlxuICAgICAgICAgIHJlcGxhY2Uoe1xuICAgICAgICAgICAgcmVnZXg6ICc8L2JvZHk+JyxcbiAgICAgICAgICAgIHJlcGxhY2VtZW50OiAnPHNjcmlwdCB0eXBlPVwidGV4dC9qYXZhc2NyaXB0XCIgc3JjPVwiJytidW5kbGVOYW1lKydcIj48L3NjcmlwdD48L2JvZHk+JyxcbiAgICAgICAgICAgIHBhdGhzOiBbcGF0aC5qb2luKHByb2RCdWlsZFBhdGgsICdpbmRleC5odG1sJyldXG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgfVxufVxuIl19