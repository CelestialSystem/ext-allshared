'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require('@babel/polyfill');

const fs = require('fs');

const path = require('path');

const pluginUtil = require(`./pluginUtil`);

const replace = require("replace"); // process.stdin.resume();
// process.on('SIGINT', function () {
//   console.log('Got SIGINT.  Press Control-D to exit.');
// });
// function cleanUpServer(eventType) {
//   console.log(eventType)
//   process.exit();
// }
// [`exit`, `SIGINT`, `SIGUSR1`, `SIGUSR2`, `uncaughtException`, `SIGTERM`].forEach((eventType) => {
//   process.on(eventType, cleanUpServer.bind(null, eventType));
// })


class ExtWebpackPlugin {
  constructor(options) {
    var constructorOutput = pluginUtil._constructor(options);

    this.vars = constructorOutput.vars;
    this.options = constructorOutput.options;
    this.vars.child = null;
    var me = this;
    var v = [`exit`, `SIGINT`, `SIGUSR1`, `SIGUSR2`, `uncaughtException`, `SIGTERM`];
    v.forEach(eventType => {
      process.on(eventType, function (eventType) {
        if (me.vars.child != null) {
          console.log('\nnode process and sencha cmd process ended');
          me.vars.child.kill();
          me.vars.child = null;
        } else {
          if (eventType != 0) {
            console.log('\nnode process ended');
          }
        }

        process.exit();
      });
    }); //console.log('added')
  }

  apply(compiler) {
    const vars = this.vars;
    const options = this.options;
    const app = this.app;

    if (!compiler.hooks) {
      console.log('not webpack 4');
      return;
    }

    compiler.hooks.thisCompilation.tap(`ext-this-compilation`, compilation => {
      pluginUtil.logh(app, `HOOK thisCompilation`);

      pluginUtil._thisCompilation(compiler, compilation, vars, options);

      if (vars.pluginErrors.length > 0) {
        compilation.errors.push(new Error(vars.pluginErrors.join("")));
        return;
      }
    }); //var cRun = 0;

    compiler.hooks.compilation.tap(`ext-compilation`, compilation => {
      pluginUtil.logh(app, `HOOK compilation`); //if (cRun == 0) {

      pluginUtil._compilation(compiler, compilation, vars, options); //}
      //cRun++;

    });
    compiler.hooks.afterCompile.tap('ext-after-compile', compilation => {
      pluginUtil.logh(app, `HOOK afterCompile`);

      pluginUtil._afterCompile(compiler, compilation, vars, options);
    });
    compiler.hooks.emit.tapAsync(`ext-emit`, (compilation, callback) => {
      pluginUtil.logh(app, `HOOK emit (async)`);

      pluginUtil._emit(compiler, compilation, vars, options, callback);
    });
    compiler.hooks.done.tap(`ext-done`, stats => {
      pluginUtil.logh(app, `HOOK done`);
      this.postBuildProcess(stats.compilation.outputOptions);

      pluginUtil._done(stats, vars, options);
    });
  }

  postBuildProcess(options) {
    /**
       * 1. Read the temp file written by the Cmd plugin to get the app.json configured build path
       * 2. Extract the path as a String, trimmed to the location of the build folder
       * 3. Copy webpack bundle to destination directory
       * 4. Delete the temp file
       */
    const outputPath = options.path;
    const bundleName = options.filename == "[name].js" ? "main.js" : options.filename;
    const tempFilePath = outputPath + 'temp.txt';
    const buildFolder = "build";

    if (fs.existsSync(tempFilePath)) {
      const configProdPath = fs.readFileSync(tempFilePath, "utf8").toString().trim();
      fs.unlinkSync(tempFilePath);
      const trimmedProdPathIndex = configProdPath.indexOf(buildFolder);
      const prodBuildPath = configProdPath.substring(trimmedProdPathIndex);
      const copyBundleDest = path.join(prodBuildPath, bundleName);

      if (fs.existsSync(bundleName)) {
        fs.copyFileSync(bundleName, copyBundleDest); // Due to the race condition between Cmd's processing for production files and the webpack bundling
        // index.html doesn't receive the injected reference to the webpack bundle.

        replace({
          regex: '</body>',
          replacement: '<script type="text/javascript" src="' + bundleName + '"></script></body>',
          paths: [path.join(prodBuildPath, 'index.html')]
        });
      }
    }
  }

}

exports.default = ExtWebpackPlugin;
module.exports = exports.default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbmRleC5qcyJdLCJuYW1lcyI6WyJyZXF1aXJlIiwiZnMiLCJwYXRoIiwicGx1Z2luVXRpbCIsInJlcGxhY2UiLCJFeHRXZWJwYWNrUGx1Z2luIiwiY29uc3RydWN0b3IiLCJvcHRpb25zIiwiY29uc3RydWN0b3JPdXRwdXQiLCJfY29uc3RydWN0b3IiLCJ2YXJzIiwiY2hpbGQiLCJtZSIsInYiLCJmb3JFYWNoIiwiZXZlbnRUeXBlIiwicHJvY2VzcyIsIm9uIiwiY29uc29sZSIsImxvZyIsImtpbGwiLCJleGl0IiwiYXBwbHkiLCJjb21waWxlciIsImFwcCIsImhvb2tzIiwidGhpc0NvbXBpbGF0aW9uIiwidGFwIiwiY29tcGlsYXRpb24iLCJsb2doIiwiX3RoaXNDb21waWxhdGlvbiIsInBsdWdpbkVycm9ycyIsImxlbmd0aCIsImVycm9ycyIsInB1c2giLCJFcnJvciIsImpvaW4iLCJfY29tcGlsYXRpb24iLCJhZnRlckNvbXBpbGUiLCJfYWZ0ZXJDb21waWxlIiwiZW1pdCIsInRhcEFzeW5jIiwiY2FsbGJhY2siLCJfZW1pdCIsImRvbmUiLCJzdGF0cyIsInBvc3RCdWlsZFByb2Nlc3MiLCJvdXRwdXRPcHRpb25zIiwiX2RvbmUiLCJvdXRwdXRQYXRoIiwiYnVuZGxlTmFtZSIsImZpbGVuYW1lIiwidGVtcEZpbGVQYXRoIiwiYnVpbGRGb2xkZXIiLCJleGlzdHNTeW5jIiwiY29uZmlnUHJvZFBhdGgiLCJyZWFkRmlsZVN5bmMiLCJ0b1N0cmluZyIsInRyaW0iLCJ1bmxpbmtTeW5jIiwidHJpbW1lZFByb2RQYXRoSW5kZXgiLCJpbmRleE9mIiwicHJvZEJ1aWxkUGF0aCIsInN1YnN0cmluZyIsImNvcHlCdW5kbGVEZXN0IiwiY29weUZpbGVTeW5jIiwicmVnZXgiLCJyZXBsYWNlbWVudCIsInBhdGhzIl0sIm1hcHBpbmdzIjoiQUFDQTs7Ozs7OztBQUNBQSxPQUFPLENBQUMsaUJBQUQsQ0FBUDs7QUFDQSxNQUFNQyxFQUFFLEdBQUdELE9B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QUFHTmtCLFVBQUFBLEtBQUssRUFBRSxDQUFDbEUsSUFBSSxDQUFDa0MsSUFBTCxDQUFVMEIsYUFBVixFQUF5QixZQUF6QixDQUFEO0FBSEQsU0FBRCxDQUFQO0FBS0Q7QUFDRjtBQUNKOztBQS9HbUMiLCJzb3VyY2VzQ29udGVudCI6WyJcbid1c2Ugc3RyaWN0J1xucmVxdWlyZSgnQGJhYmVsL3BvbHlmaWxsJylcbmNvbnN0IGZzID0gcmVxdWlyZSgnZnMnKTtcbmNvbnN0IHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XG5jb25zdCBwbHVnaW5VdGlsID0gcmVxdWlyZShgLi9wbHVnaW5VdGlsYClcbmNvbnN0IHJlcGxhY2UgPSByZXF1aXJlKFwicmVwbGFjZVwiKTtcblxuLy8gcHJvY2Vzcy5zdGRpbi5yZXN1bWUoKTtcbi8vIHByb2Nlc3Mub24oJ1NJR0lOVCcsIGZ1bmN0aW9uICgpIHtcbi8vICAgY29uc29sZS5sb2coJ0dvdCBTSUdJTlQuICBQcmVzcyBDb250cm9sLUQgdG8gZXhpdC4nKTtcbi8vIH0pO1xuLy8gZnVuY3Rpb24gY2xlYW5VcFNlcnZlcihldmVudFR5cGUpIHtcbi8vICAgY29uc29sZS5sb2coZXZlbnRUeXBlKVxuLy8gICBwcm9jZXNzLmV4aXQoKTtcbi8vIH1cbi8vIFtgZXhpdGAsIGBTSUdJTlRgLCBgU0lHVVNSMWAsIGBTSUdVU1IyYCwgYHVuY2F1Z2h0RXhjZXB0aW9uYCwgYFNJR1RFUk1gXS5mb3JFYWNoKChldmVudFR5cGUpID0+IHtcbi8vICAgcHJvY2Vzcy5vbihldmVudFR5cGUsIGNsZWFuVXBTZXJ2ZXIuYmluZChudWxsLCBldmVudFR5cGUpKTtcbi8vIH0pXG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIEV4dFdlYnBhY2tQbHVnaW4ge1xuXG4gIGNvbnN0cnVjdG9yKG9wdGlvbnMpIHtcbiAgICB2YXIgY29uc3RydWN0b3JPdXRwdXQgPSBwbHVnaW5VdGlsLl9jb25zdHJ1Y3RvcihvcHRpb25zKVxuICAgIHRoaXMudmFycyA9IGNvbnN0cnVjdG9yT3V0cHV0LnZhcnNcbiAgICB0aGlzLm9wdGlvbnMgPSBjb25zdHJ1Y3Rvck91dHB1dC5vcHRpb25zXG5cbiAgICB0aGlzLnZhcnMuY2hpbGQgPSBudWxsO1xuICAgIHZhciBtZSA9IHRoaXM7XG5cbiAgICB2YXIgdiA9IFtgZXhpdGAsIGBTSUdJTlRgLCBgU0lHVVNSMWAsIGBTSUdVU1IyYCwgYHVuY2F1Z2h0RXhjZXB0aW9uYCwgYFNJR1RFUk1gXVxuICAgIHYuZm9yRWFjaChldmVudFR5cGUgPT4ge1xuICAgICAgcHJvY2Vzcy5vbihldmVudFR5cGUsIGZ1bmN0aW9uKGV2ZW50VHlwZSl7XG4gICAgICAgIGlmIChtZS52YXJzLmNoaWxkICE9IG51bGwpIHtcbiAgICAgICAgICBjb25zb2xlLmxvZygnXFxubm9kZSBwcm9jZXNzIGFuZCBzZW5jaGEgY21kIHByb2Nlc3MgZW5kZWQnKVxuICAgICAgICAgIG1lLnZhcnMuY2hpbGQua2lsbCgpO1xuICAgICAgICAgIG1lLnZhcnMuY2hpbGQgPSBudWxsO1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgIGlmIChldmVudFR5cGUgIT0gMCkge1xuICAgICAgICAgICAgY29uc29sZS5sb2coJ1xcbm5vZGUgcHJvY2VzcyBlbmRlZCcpXG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHByb2Nlc3MuZXhpdCgpO1xuICAgICAgfSk7XG4gICAgfSlcbiAgICAvL2NvbnNvbGUubG9nKCdhZGRlZCcpXG4gIH1cblxuICBhcHBseShjb21waWxlcikge1xuICAgIGNvbnN0IHZhcnMgPSB0aGlzLnZhcnNcbiAgICBjb25zdCBvcHRpb25zID0gdGhpcy5vcHRpb25zXG4gICAgY29uc3QgYXBwID0gdGhpcy5hcHBcblxuICAgIGlmICghY29tcGlsZXIuaG9va3MpIHtcbiAgICAgIGNvbnNvbGUubG9nKCdub3Qgd2VicGFjayA0Jyk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29tcGlsZXIuaG9va3MudGhpc0NvbXBpbGF0aW9uLnRhcChgZXh0LXRoaXMtY29tcGlsYXRpb25gLCAoY29tcGlsYXRpb24pID0+IHtcbiAgICAgIHBsdWdpblV0aWwubG9naChhcHAsIGBIT09LIHRoaXNDb21waWxhdGlvbmApXG4gICAgICBwbHVnaW5VdGlsLl90aGlzQ29tcGlsYXRpb24oY29tcGlsZXIsIGNvbXBpbGF0aW9uLCB2YXJzLCBvcHRpb25zKVxuXG4gICAgICBpZiAodmFycy5wbHVnaW5FcnJvcnMubGVuZ3RoID4gMCkge1xuICAgICAgICBjb21waWxhdGlvbi5lcnJvcnMucHVzaCggbmV3IEVycm9yKHZhcnMucGx1Z2luRXJyb3JzLmpvaW4oXCJcIikpIClcbiAgICAgICAgcmV0dXJuXG4gICAgICB9XG4gICAgfSlcblxuICAgIC8vdmFyIGNSdW4gPSAwO1xuICAgIGNvbXBpbGVyLmhvb2tzLmNvbXBpbGF0aW9uLnRhcChgZXh0LWNvbXBpbGF0aW9uYCwgKGNvbXBpbGF0aW9uKSA9PiB7XG4gICAgICBwbHVnaW5VdGlsLmxvZ2goYXBwLCBgSE9PSyBjb21waWxhdGlvbmApXG4gICAgICAvL2lmIChjUnVuID09IDApIHtcbiAgICAgICAgcGx1Z2luVXRpbC5fY29tcGlsYXRpb24oY29tcGlsZXIsIGNvbXBpbGF0aW9uLCB2YXJzLCBvcHRpb25zKTtcbiAgICAgIC8vfVxuICAgICAgLy9jUnVuKys7XG4gICAgfSlcblxuICAgIGNvbXBpbGVyLmhvb2tzLmFmdGVyQ29tcGlsZS50YXAoJ2V4dC1hZnRlci1jb21waWxlJywgKGNvbXBpbGF0aW9uKSA9PiB7XG4gICAgICBwbHVnaW5VdGlsLmxvZ2goYXBwLCBgSE9PSyBhZnRlckNvbXBpbGVgKVxuICAgICAgcGx1Z2luVXRpbC5fYWZ0ZXJDb21waWxlKGNvbXBpbGVyLCBjb21waWxhdGlvbiwgdmFycywgb3B0aW9ucylcbiAgICB9KVxuXG4gICAgY29tcGlsZXIuaG9va3MuZW1pdC50YXBBc3luYyhgZXh0LWVtaXRgLCAoY29tcGlsYXRpb24sIGNhbGxiYWNrKSA9PiB7XG4gICAgICBwbHVnaW5VdGlsLmxvZ2goYXBwLCBgSE9PSyBlbWl0IChhc3luYylgKVxuXG5cblxuXG5cblxuICAgICAgcGx1Z2luVXRpbC5fZW1pdChjb21waWxlciwgY29tcGlsYXRpb24sIHZhcnMsIG9wdGlvbnMsIGNhbGxiYWNrKVxuICAgIH0pXG5cbiAgICBjb21waWxlci5ob29rcy5kb25lLnRhcChgZXh0LWRvbmVgLCAoc3RhdHMpID0+IHtcbiAgICAgIHBsdWdpblV0aWwubG9naChhcHAsIGBIT09LIGRvbmVgKVxuICAgICAgdGhpcy5wb3N0QnVpbGRQcm9jZXNzKHN0YXRzLmNvbXBpbGF0aW9uLm91dHB1dE9wdGlvbnMpXG4gICAgICBwbHVnaW5VdGlsLl9kb25lKHN0YXRzLCB2YXJzLCBvcHRpb25zKVxuICAgIH0pXG4gIH1cblxuICBwb3N0QnVpbGRQcm9jZXNzKG9wdGlvbnMpIHtcbiAgICAvKipcbiAgICAgICAqIDEuIFJlYWQgdGhlIHRlbXAgZmlsZSB3cml0dGVuIGJ5IHRoZSBDbWQgcGx1Z2luIHRvIGdldCB0aGUgYXBwLmpzb24gY29uZmlndXJlZCBidWlsZCBwYXRoXG4gICAgICAgKiAyLiBFeHRyYWN0IHRoZSBwYXRoIGFzIGEgU3RyaW5nLCB0cmltbWVkIHRvIHRoZSBsb2NhdGlvbiBvZiB0aGUgYnVpbGQgZm9sZGVyXG4gICAgICAgKiAzLiBDb3B5IHdlYnBhY2sgYnVuZGxlIHRvIGRlc3RpbmF0aW9uIGRpcmVjdG9yeVxuICAgICAgICogNC4gRGVsZXRlIHRoZSB0ZW1wIGZpbGVcbiAgICAgICAqL1xuICAgICAgY29uc3Qgb3V0cHV0UGF0aCA9IG9wdGlvbnMucGF0aDtcbiAgICAgIGNvbnN0IGJ1bmRsZU5hbWUgPSAoKG9wdGlvbnMuZmlsZW5hbWUgPT0gXCJbbmFtZV0uanNcIikgPyBcIm1haW4uanNcIiA6IG9wdGlvbnMuZmlsZW5hbWUpO1xuICAgICAgY29uc3QgdGVtcEZpbGVQYXRoID0gb3V0cHV0UGF0aCsndGVtcC50eHQnO1xuICAgICAgY29uc3QgYnVpbGRGb2xkZXIgPSBcImJ1aWxkXCJcblxuICAgICAgaWYgKGZzLmV4aXN0c1N5bmModGVtcEZpbGVQYXRoKSkge1xuICAgICAgICBjb25zdCBjb25maWdQcm9kUGF0aCA9IGZzLnJlYWRGaWxlU3luYyh0ZW1wRmlsZVBhdGgsIFwidXRmOFwiKS50b1N0cmluZygpLnRyaW0oKTtcbiAgICAgICAgZnMudW5saW5rU3luYyh0ZW1wRmlsZVBhdGgpO1xuICAgICAgICBjb25zdCB0cmltbWVkUHJvZFBhdGhJbmRleCA9IGNvbmZpZ1Byb2RQYXRoLmluZGV4T2YoYnVpbGRGb2xkZXIpO1xuICAgICAgICBjb25zdCBwcm9kQnVpbGRQYXRoID0gY29uZmlnUHJvZFBhdGguc3Vic3RyaW5nKHRyaW1tZWRQcm9kUGF0aEluZGV4KVxuICAgICAgICBjb25zdCBjb3B5QnVuZGxlRGVzdCA9IHBhdGguam9pbihwcm9kQnVpbGRQYXRoLCBidW5kbGVOYW1lKTtcbiAgICAgICAgaWYgKGZzLmV4aXN0c1N5bmMoYnVuZGxlTmFtZSkpIHtcbiAgICAgICAgICBmcy5jb3B5RmlsZVN5bmMoYnVuZGxlTmFtZSwgY29weUJ1bmRsZURlc3QpO1xuXG4gICAgICAgICAgLy8gRHVlIHRvIHRoZSByYWNlIGNvbmRpdGlvbiBiZXR3ZWVuIENtZCdzIHByb2Nlc3NpbmcgZm9yIHByb2R1Y3Rpb24gZmlsZXMgYW5kIHRoZSB3ZWJwYWNrIGJ1bmRsaW5nXG4gICAgICAgICAgLy8gaW5kZXguaHRtbCBkb2Vzbid0IHJlY2VpdmUgdGhlIGluamVjdGVkIHJlZmVyZW5jZSB0byB0aGUgd2VicGFjayBidW5kbGUuXG4gICAgICAgICAgcmVwbGFjZSh7XG4gICAgICAgICAgICByZWdleDogJzwvYm9keT4nLFxuICAgICAgICAgICAgcmVwbGFjZW1lbnQ6ICc8c2NyaXB0IHR5cGU9XCJ0ZXh0L2phdmFzY3JpcHRcIiBzcmM9XCInK2J1bmRsZU5hbWUrJ1wiPjwvc2NyaXB0PjwvYm9keT4nLFxuICAgICAgICAgICAgcGF0aHM6IFtwYXRoLmpvaW4ocHJvZEJ1aWxkUGF0aCwgJ2luZGV4Lmh0bWwnKV1cbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgfVxuICB9XG59XG4iXX0=