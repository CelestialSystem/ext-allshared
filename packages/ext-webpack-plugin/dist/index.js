'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require('@babel/polyfill');

const fs = require('fs');

const path = require('path');

const pluginUtil = require(`./pluginUtil`); // process.stdin.resume();
// process.on('SIGINT', function () {
//   console.log('Got SIGINT.  Press Control-D to exit.');
// });
// function cleanUpServer(eventType) {
//   console.log(eventType)
//   process.exit();
// }
// [`exit`, `SIGINT`, `SIGUSR1`, `SIGUSR2`, `uncaughtException`, `SIGTERM`].forEach((eventType) => {
//   process.on(eventType, cleanUpServer.bind(null, eventType));
// })


class ExtWebpackPlugin {
  constructor(options) {
    var constructorOutput = pluginUtil._constructor(options);

    this.vars = constructorOutput.vars;
    this.options = constructorOutput.options;
    this.vars.child = null;
    var me = this;
    [`exit`, `SIGINT`, `SIGUSR1`, `SIGUSR2`, `uncaughtException`, `SIGTERM`].forEach(eventType => {
      //process.on(eventType, me.cleanUpServer2.bind(null, eventType));
      process.on(eventType, function (eventType) {
        console.log(eventType); //console.log(me.vars.child)

        if (me.vars.child != null) {
          console.log(me.vars.child.kill);
          me.vars.child.kill();
        } else {
          console.log('child is null');
        }

        process.exit();
      });
    });
    console.log('added');
  } // cleanUpServer2(eventType) {
  //   console.log(eventType)
  //   console.log(this.vars.child)
  //   process.exit();
  // }


  apply(compiler) {
    const vars = this.vars;
    const options = this.options;
    const app = this.app;

    if (!compiler.hooks) {
      console.log('not webpack 4');
      return;
    }

    compiler.hooks.thisCompilation.tap(`ext-this-compilation`, compilation => {
      pluginUtil.logh(app, `HOOK thisCompilation`);

      pluginUtil._thisCompilation(compiler, compilation, vars, options);

      if (vars.pluginErrors.length > 0) {
        compilation.errors.push(new Error(vars.pluginErrors.join("")));
        return;
      }
    }); //var cRun = 0;

    compiler.hooks.compilation.tap(`ext-compilation`, compilation => {
      pluginUtil.logh(app, `HOOK compilation`); //if (cRun == 0) {

      pluginUtil._compilation(compiler, compilation, vars, options); //}
      //cRun++;

    });
    compiler.hooks.afterCompile.tap('ext-after-compile', compilation => {
      pluginUtil.logh(app, `HOOK afterCompile`);

      pluginUtil._afterCompile(compiler, compilation, vars, options);
    });
    compiler.hooks.emit.tapAsync(`ext-emit`, (compilation, callback) => {
      pluginUtil.logh(app, `HOOK emit (async)`);

      pluginUtil._emit(compiler, compilation, vars, options, callback);
    });
    compiler.hooks.done.tap(`ext-done`, stats => {
      pluginUtil.logh(app, `HOOK done`);
      this.postBuildProcess(stats.compilation.outputOptions);

      pluginUtil._done(stats, vars, options);
    });
  }

  postBuildProcess(options) {
    /**
       * 1. Read the temp file written by the Cmd plugin to get the app.json configured build path
       * 2. Extract the path as a String, trimmed to the location of the build folder
       * 3. Copy webpack bundle and index.html to destination directory
       * 4. Delete the temp file
       */
    const outputPath = options.path;
    const bundleName = options.filename == "[name].js" ? "main.js" : options.filename;
    const indexHTML = "index.html";
    const indexPath = outputPath + indexHTML;
    const tempFilePath = outputPath + 'temp.txt';
    const buildFolder = "build";

    if (fs.existsSync(tempFilePath)) {
      const configProdPath = fs.readFileSync(tempFilePath, "utf8").toString().trim();
      fs.unlinkSync(tempFilePath);
      const trimmedProdPathIndex = configProdPath.indexOf(buildFolder);
      const prodBuildPath = configProdPath.substring(trimmedProdPathIndex);
      const copyBundleDest = path.join(prodBuildPath, bundleName);
      const copyIndexDest = path.join(prodBuildPath, indexHTML);

      if (fs.existsSync(bundleName)) {
        fs.copyFileSync(bundleName, copyBundleDest);
        fs.copyFileSync(indexHTML, copyIndexDest);
      }
    }
  }

}

exports.default = ExtWebpackPlugin;
module.exports = exports.default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbmRleC5qcyJdLCJuYW1lcyI6WyJyZXF1aXJlIiwiZnMiLCJwYXRoIiwicGx1Z2luVXRpbCIsIkV4dFdlYnBhY2tQbHVnaW4iLCJjb25zdHJ1Y3RvciIsIm9wdGlvbnMiLCJjb25zdHJ1Y3Rvck91dHB1dCIsIl9jb25zdHJ1Y3RvciIsInZhcnMiLCJjaGlsZCIsIm1lIiwiZm9yRWFjaCIsImV2ZW50VHlwZSIsInByb2Nlc3MiLCJvbiIsImNvbnNvbGUiLCJsb2ciLCJraWxsIiwiZXhpdCIsImFwcGx5IiwiY29tcGlsZXIiLCJhcHAiLCJob29rcyIsInRoaXNDb21waWxhdGlvbiIsInRhcCIsImNvbXBpbGF0aW9uIiwibG9naCIsIl90aGlzQ29tcGlsYXRpb24iLCJwbHVnaW5FcnJvcnMiLCJsZW5ndGgiLCJlcnJvcnMiLCJwdXNoIiwiRXJyb3IiLCJqb2luIiwiX2NvbXBpbGF0aW9uIiwiYWZ0ZXJDb21waWxlIiwiX2FmdGVyQ29tcGlsZSIsImVtaXQiLCJ0YXBBc3luYyIsImNhbGxiYWNrIiwiX2VtaXQiLCJkb25lIiwic3RhdHMiLCJwb3N0QnVpbGRQcm9jZXNzIiwib3V0cHV0T3B0aW9ucyIsIl9kb25lIiwib3V0cHV0UGF0aCIsImJ1bmRsZU5hbWUiLCJmaWxlbmFtZSIsImluZGV4SFRNTCIsImluZGV4UGF0aCIsInRlbXBGaWxlUGF0aCIsImJ1aWxkRm9sZGVyIiwiZXhpc3RzU3luYyIsImNvbmZpZ1Byb2RQYXRoIiwicmVhZEZpbGVTeW5jIiwidG9TdHJpbmciLCJ0cmltIiwidW5saW5rU3luYyIsInRyaW1tZWRQcm9kUGF0aEluZGV4IiwiaW5kZXhPZiIsInByb2RCdWlsZFBhdGgiLCJzdWJzdHJpbmciLCJjb3B5QnVuZGxlRGVzdCIsImNvcHlJbmRleERlc3QiLCJjb3B5RmlsZVN5bmMiXSwibWFwcGluZ3MiOiJBQUNBOzs7Ozs7O0FBQ0FBLE9BQU8sQ0FBQyxpQkFBRCxDQUFQOztBQUNBLE1BQU1DLEVBQUUsR0FBR0QsT0FBTyxD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Q0EvRCxRQUFBQSxFQUFFLENBQUNpRSxZQUFILENBQWdCaEIsU0FBaEIsRUFBMkJlLGFBQTNCO0FBQ0Q7QUFDRjtBQUNKOztBQTdIbUMiLCJzb3VyY2VzQ29udGVudCI6WyJcbid1c2Ugc3RyaWN0J1xucmVxdWlyZSgnQGJhYmVsL3BvbHlmaWxsJylcbmNvbnN0IGZzID0gcmVxdWlyZSgnZnMnKTtcbmNvbnN0IHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XG5jb25zdCBwbHVnaW5VdGlsID0gcmVxdWlyZShgLi9wbHVnaW5VdGlsYClcblxuLy8gcHJvY2Vzcy5zdGRpbi5yZXN1bWUoKTtcblxuLy8gcHJvY2Vzcy5vbignU0lHSU5UJywgZnVuY3Rpb24gKCkge1xuLy8gICBjb25zb2xlLmxvZygnR290IFNJR0lOVC4gIFByZXNzIENvbnRyb2wtRCB0byBleGl0LicpO1xuLy8gfSk7XG5cbi8vIGZ1bmN0aW9uIGNsZWFuVXBTZXJ2ZXIoZXZlbnRUeXBlKSB7XG4vLyAgIGNvbnNvbGUubG9nKGV2ZW50VHlwZSlcbi8vICAgcHJvY2Vzcy5leGl0KCk7XG5cbi8vIH1cblxuLy8gW2BleGl0YCwgYFNJR0lOVGAsIGBTSUdVU1IxYCwgYFNJR1VTUjJgLCBgdW5jYXVnaHRFeGNlcHRpb25gLCBgU0lHVEVSTWBdLmZvckVhY2goKGV2ZW50VHlwZSkgPT4ge1xuLy8gICBwcm9jZXNzLm9uKGV2ZW50VHlwZSwgY2xlYW5VcFNlcnZlci5iaW5kKG51bGwsIGV2ZW50VHlwZSkpO1xuLy8gfSlcblxuXG5cblxuXG5cblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgRXh0V2VicGFja1BsdWdpbiB7XG5cbiAgY29uc3RydWN0b3Iob3B0aW9ucykge1xuICAgIHZhciBjb25zdHJ1Y3Rvck91dHB1dCA9IHBsdWdpblV0aWwuX2NvbnN0cnVjdG9yKG9wdGlvbnMpXG4gICAgdGhpcy52YXJzID0gY29uc3RydWN0b3JPdXRwdXQudmFyc1xuICAgIHRoaXMub3B0aW9ucyA9IGNvbnN0cnVjdG9yT3V0cHV0Lm9wdGlvbnNcblxuICAgIHRoaXMudmFycy5jaGlsZCA9IG51bGw7XG5cblxuXG4gICAgdmFyIG1lID0gdGhpcztcblxuICAgIFtgZXhpdGAsIGBTSUdJTlRgLCBgU0lHVVNSMWAsIGBTSUdVU1IyYCwgYHVuY2F1Z2h0RXhjZXB0aW9uYCwgYFNJR1RFUk1gXS5mb3JFYWNoKChldmVudFR5cGUpID0+IHtcbiAgICAgIC8vcHJvY2Vzcy5vbihldmVudFR5cGUsIG1lLmNsZWFuVXBTZXJ2ZXIyLmJpbmQobnVsbCwgZXZlbnRUeXBlKSk7XG5cbiAgICAgIHByb2Nlc3Mub24oZXZlbnRUeXBlLCBmdW5jdGlvbihldmVudFR5cGUpe1xuICAgICAgICBjb25zb2xlLmxvZyhldmVudFR5cGUpXG4gICAgICAgIC8vY29uc29sZS5sb2cobWUudmFycy5jaGlsZClcbiAgICAgICAgaWYgKG1lLnZhcnMuY2hpbGQgIT0gbnVsbCkge1xuICAgICAgICAgIGNvbnNvbGUubG9nKG1lLnZhcnMuY2hpbGQua2lsbClcbiAgICAgICAgICBtZS52YXJzLmNoaWxkLmtpbGwoKTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICBjb25zb2xlLmxvZygnY2hpbGQgaXMgbnVsbCcpXG4gICAgICAgIH1cbiAgICAgICAgcHJvY2Vzcy5leGl0KCk7XG4gICAgICB9KTtcblxuXG5cbiAgICB9KVxuICAgIGNvbnNvbGUubG9nKCdhZGRlZCcpXG5cblxuXG4gIH1cblxuXG4gIC8vIGNsZWFuVXBTZXJ2ZXIyKGV2ZW50VHlwZSkge1xuICAvLyAgIGNvbnNvbGUubG9nKGV2ZW50VHlwZSlcbiAgLy8gICBjb25zb2xlLmxvZyh0aGlzLnZhcnMuY2hpbGQpXG4gIC8vICAgcHJvY2Vzcy5leGl0KCk7XG5cbiAgLy8gfVxuXG5cbiAgYXBwbHkoY29tcGlsZXIpIHtcbiAgICBjb25zdCB2YXJzID0gdGhpcy52YXJzXG4gICAgY29uc3Qgb3B0aW9ucyA9IHRoaXMub3B0aW9uc1xuICAgIGNvbnN0IGFwcCA9IHRoaXMuYXBwXG5cbiAgICBpZiAoIWNvbXBpbGVyLmhvb2tzKSB7XG4gICAgICBjb25zb2xlLmxvZygnbm90IHdlYnBhY2sgNCcpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbXBpbGVyLmhvb2tzLnRoaXNDb21waWxhdGlvbi50YXAoYGV4dC10aGlzLWNvbXBpbGF0aW9uYCwgKGNvbXBpbGF0aW9uKSA9PiB7XG4gICAgICBwbHVnaW5VdGlsLmxvZ2goYXBwLCBgSE9PSyB0aGlzQ29tcGlsYXRpb25gKVxuICAgICAgcGx1Z2luVXRpbC5fdGhpc0NvbXBpbGF0aW9uKGNvbXBpbGVyLCBjb21waWxhdGlvbiwgdmFycywgb3B0aW9ucylcblxuICAgICAgaWYgKHZhcnMucGx1Z2luRXJyb3JzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgY29tcGlsYXRpb24uZXJyb3JzLnB1c2goIG5ldyBFcnJvcih2YXJzLnBsdWdpbkVycm9ycy5qb2luKFwiXCIpKSApXG4gICAgICAgIHJldHVyblxuICAgICAgfVxuICAgIH0pXG5cbiAgICAvL3ZhciBjUnVuID0gMDtcbiAgICBjb21waWxlci5ob29rcy5jb21waWxhdGlvbi50YXAoYGV4dC1jb21waWxhdGlvbmAsIChjb21waWxhdGlvbikgPT4ge1xuICAgICAgcGx1Z2luVXRpbC5sb2doKGFwcCwgYEhPT0sgY29tcGlsYXRpb25gKVxuICAgICAgLy9pZiAoY1J1biA9PSAwKSB7XG4gICAgICAgIHBsdWdpblV0aWwuX2NvbXBpbGF0aW9uKGNvbXBpbGVyLCBjb21waWxhdGlvbiwgdmFycywgb3B0aW9ucyk7XG4gICAgICAvL31cbiAgICAgIC8vY1J1bisrO1xuICAgIH0pXG5cbiAgICBjb21waWxlci5ob29rcy5hZnRlckNvbXBpbGUudGFwKCdleHQtYWZ0ZXItY29tcGlsZScsIChjb21waWxhdGlvbikgPT4ge1xuICAgICAgcGx1Z2luVXRpbC5sb2doKGFwcCwgYEhPT0sgYWZ0ZXJDb21waWxlYClcbiAgICAgIHBsdWdpblV0aWwuX2FmdGVyQ29tcGlsZShjb21waWxlciwgY29tcGlsYXRpb24sIHZhcnMsIG9wdGlvbnMpXG4gICAgfSlcblxuICAgIGNvbXBpbGVyLmhvb2tzLmVtaXQudGFwQXN5bmMoYGV4dC1lbWl0YCwgKGNvbXBpbGF0aW9uLCBjYWxsYmFjaykgPT4ge1xuICAgICAgcGx1Z2luVXRpbC5sb2doKGFwcCwgYEhPT0sgZW1pdCAoYXN5bmMpYClcblxuXG5cblxuXG5cbiAgICAgIHBsdWdpblV0aWwuX2VtaXQoY29tcGlsZXIsIGNvbXBpbGF0aW9uLCB2YXJzLCBvcHRpb25zLCBjYWxsYmFjaylcbiAgICB9KVxuXG4gICAgY29tcGlsZXIuaG9va3MuZG9uZS50YXAoYGV4dC1kb25lYCwgKHN0YXRzKSA9PiB7XG4gICAgICBwbHVnaW5VdGlsLmxvZ2goYXBwLCBgSE9PSyBkb25lYClcbiAgICAgIHRoaXMucG9zdEJ1aWxkUHJvY2VzcyhzdGF0cy5jb21waWxhdGlvbi5vdXRwdXRPcHRpb25zKVxuICAgICAgcGx1Z2luVXRpbC5fZG9uZShzdGF0cywgdmFycywgb3B0aW9ucylcbiAgICB9KVxuICB9XG5cbiAgcG9zdEJ1aWxkUHJvY2VzcyhvcHRpb25zKSB7XG4gICAgLyoqXG4gICAgICAgKiAxLiBSZWFkIHRoZSB0ZW1wIGZpbGUgd3JpdHRlbiBieSB0aGUgQ21kIHBsdWdpbiB0byBnZXQgdGhlIGFwcC5qc29uIGNvbmZpZ3VyZWQgYnVpbGQgcGF0aFxuICAgICAgICogMi4gRXh0cmFjdCB0aGUgcGF0aCBhcyBhIFN0cmluZywgdHJpbW1lZCB0byB0aGUgbG9jYXRpb24gb2YgdGhlIGJ1aWxkIGZvbGRlclxuICAgICAgICogMy4gQ29weSB3ZWJwYWNrIGJ1bmRsZSBhbmQgaW5kZXguaHRtbCB0byBkZXN0aW5hdGlvbiBkaXJlY3RvcnlcbiAgICAgICAqIDQuIERlbGV0ZSB0aGUgdGVtcCBmaWxlXG4gICAgICAgKi9cbiAgICAgIGNvbnN0IG91dHB1dFBhdGggPSBvcHRpb25zLnBhdGg7XG4gICAgICBjb25zdCBidW5kbGVOYW1lID0gKChvcHRpb25zLmZpbGVuYW1lID09IFwiW25hbWVdLmpzXCIpID8gXCJtYWluLmpzXCIgOiBvcHRpb25zLmZpbGVuYW1lKTtcbiAgICAgIGNvbnN0IGluZGV4SFRNTCA9IFwiaW5kZXguaHRtbFwiO1xuICAgICAgY29uc3QgaW5kZXhQYXRoID0gb3V0cHV0UGF0aCtpbmRleEhUTUw7XG4gICAgICBjb25zdCB0ZW1wRmlsZVBhdGggPSBvdXRwdXRQYXRoKyd0ZW1wLnR4dCc7XG4gICAgICBjb25zdCBidWlsZEZvbGRlciA9IFwiYnVpbGRcIlxuXG4gICAgICBpZiAoZnMuZXhpc3RzU3luYyh0ZW1wRmlsZVBhdGgpKSB7XG4gICAgICAgIGNvbnN0IGNvbmZpZ1Byb2RQYXRoID0gZnMucmVhZEZpbGVTeW5jKHRlbXBGaWxlUGF0aCwgXCJ1dGY4XCIpLnRvU3RyaW5nKCkudHJpbSgpO1xuICAgICAgICBmcy51bmxpbmtTeW5jKHRlbXBGaWxlUGF0aCk7XG4gICAgICAgIGNvbnN0IHRyaW1tZWRQcm9kUGF0aEluZGV4ID0gY29uZmlnUHJvZFBhdGguaW5kZXhPZihidWlsZEZvbGRlcik7XG4gICAgICAgIGNvbnN0IHByb2RCdWlsZFBhdGggPSBjb25maWdQcm9kUGF0aC5zdWJzdHJpbmcodHJpbW1lZFByb2RQYXRoSW5kZXgpXG4gICAgICAgIGNvbnN0IGNvcHlCdW5kbGVEZXN0ID0gcGF0aC5qb2luKHByb2RCdWlsZFBhdGgsIGJ1bmRsZU5hbWUpO1xuICAgICAgICBjb25zdCBjb3B5SW5kZXhEZXN0ID0gcGF0aC5qb2luKHByb2RCdWlsZFBhdGgsIGluZGV4SFRNTCk7XG4gICAgICAgIGlmIChmcy5leGlzdHNTeW5jKGJ1bmRsZU5hbWUpKSB7XG4gICAgICAgICAgZnMuY29weUZpbGVTeW5jKGJ1bmRsZU5hbWUsIGNvcHlCdW5kbGVEZXN0KTtcbiAgICAgICAgICBmcy5jb3B5RmlsZVN5bmMoaW5kZXhIVE1MLCBjb3B5SW5kZXhEZXN0KTtcbiAgICAgICAgfVxuICAgICAgfVxuICB9XG59XG4iXX0=