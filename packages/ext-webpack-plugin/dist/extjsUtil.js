"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports._afterCompile = _afterCompile;
exports._prepareForBuild = _prepareForBuild;

function _afterCompile(compilation, vars, options) {
  try {
    require('./pluginUtil').logv(options, 'FUNCTION ext-after-compile');

    const path = require('path');

    let {
      files,
      dirs
    } = vars;
    const {
      cwd
    } = vars;
    files = typeof files === 'string' ? [files] : files;
    dirs = typeof dirs === 'string' ? [dirs] : dirs;

    const {
      fileDependencies,
      contextDependencies
    } = _getFileAndContextDeps(compilation, files, dirs, cwd, options);

    if (files.length > 0) {
      fileDependencies.forEach(file => {
        compilation.fileDependencies.add(path.resolve(file));
      });
    }

    if (dirs.length > 0) {
      contextDependencies.forEach(context => {
        compilation.contextDependencies.add(context);
      });
    }
  } catch (e) {
    console.log(e);
    compilation.errors.push('_afterCompile: ' + e);
  }
}

function _getFileAndContextDeps(compilation, files, dirs, cwd, options) {
  require('./pluginUtil').logv(options, 'FUNCTION _getFileAndContextDeps');

  const uniq = require('lodash.uniq');

  const isGlob = require('is-glob');

  const {
    fileDependencies,
    contextDependencies
  } = compilation;
  const isWebpack4 = compilation.hooks;
  let fds = isWebpack4 ? [...fileDependencies] : fileDependencies;
  let cds = isWebpack4 ? [...contextDependencies] : contextDependencies;

  if (files.length > 0) {
    files.forEach(pattern => {
      let f = pattern;

      if (isGlob(pattern)) {
        f = glob.sync(pattern, {
          cwd,
          dot: true,
          absolute: true
        });
      }

      fds = fds.concat(f);
    });
    fds = uniq(fds);
  }

  if (dirs.length > 0) {
    cds = uniq(cds.concat(dirs));
  }

  return {
    fileDependencies: fds,
    contextDependencies: cds
  };
}

function _prepareForBuild(app, vars, options, output, compilation) {
  try {
    const log = require('./pluginUtil').log;

    const logv = require('./pluginUtil').logv;

    logv(options, '_prepareForBuild');

    const fs = require('fs');

    const recursiveReadSync = require('recursive-readdir-sync');

    var watchedFiles = [];

    try {
      watchedFiles = recursiveReadSync('./app').concat(recursiveReadSync('./packages'));
    } catch (err) {
      if (err.errno === 34) {
        console.log('Path does not exist');
      } else {
        throw err;
      }
    }

    var currentNumFiles = watchedFiles.length;
    logv(options, 'watchedFiles: ' + currentNumFiles);
    var doBuild = true;
    logv(options, 'doBuild: ' + doBuild);
    vars.lastMilliseconds = new Date().getTime();
    var filesource = 'this file enables client reload';
    compilation.assets[currentNumFiles + 'FilesUnderAppFolder.md'] = {
      source: function () {
        return filesource;
      },
      size: function () {
        return filesource.length;
      }
    };
    logv(options, 'currentNumFiles: ' + currentNumFiles);
    logv(options, 'vars.lastNumFiles: ' + vars.lastNumFiles);
    logv(options, 'doBuild: ' + doBuild);

    if (currentNumFiles != vars.lastNumFiles || doBuild) {
      vars.rebuild = true;
      var bundleDir = output.replace(process.cwd(), '');

      if (bundleDir.trim() == '') {
        bundleDir = './';
      }

      log(app + 'Building Ext bundle at: ' + bundleDir);
    } else {
      vars.rebuild = false;
    }

    vars.lastNumFiles = currentNumFiles;
  } catch (e) {
    console.log(e);
    compilation.errors.push('_prepareForBuild: ' + e);
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9leHRqc1V0aWwuanMiXSwibmFtZXMiOlsiX2FmdGVyQ29tcGlsZSIsImNvbXBpbGF0aW9uIiwidmFycyIsIm9wdGlvbnMiLCJyZXF1aXJlIiwibG9ndiIsInBhdGgiLCJmaWxlcyIsImRpcnMiLCJjd2QiLCJmaWxlRGVwZW5kZW5jaWVzIiwiY29udGV4dERlcGVuZGVuY2llcyIsIl9nZXRGaWxlQW5kQ29udGV4dERlcHMiLCJsZW5ndGgiLCJmb3JFYWNoIiwiZmlsZSIsImFkZCIsInJlc29sdmUiLCJjb250ZXh0IiwiZSIsImNvbnNvbGUiLCJsb2ciLCJlcnJvcnMiLCJwdXNoIiwidW5pcSIsImlzR2xvYiIsImlzV2VicGFjazQiLCJob29rcyIsImZkcyIsImNkcyIsInBhdHRlcm4iLCJmIiwiZ2xvYiIsInN5bmMiLCJkb3QiLCJhYnNvbHV0ZSIsImNvbmNhdCIsIl9wcmVwYXJlRm9yQnVpbGQiLCJhcHAiLCJvdXRwdXQiLCJmcyIsInJlY3Vyc2l2ZVJlYWRTeW5jIiwid2F0Y2hlZEZpbGVzIiwiZXJyIiwiZXJybm8iLCJjdXJyZW50TnVtRmlsZXMiLCJkb0J1aWxkIiwibGFzdE1pbGxpc2Vjb25kcyIsIkRhdGUiLCJnZXRUaW1lIiwiZmlsZXNvdXJjZSIsImFzc2V0cyIsInNvdXJjZSIsInNpemUiLCJsYXN0TnVtRmlsZXMiLCJyZWJ1aWxkIiwiYnVuZGxlRGlyIiwicmVwbGFjZSIsInByb2Nlc3MiLCJ0cmltIl0sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7Ozs7QUFFTyxTQUFTQSxhQUFULENBQXVCQyxXQUF2QixFQUFvQ0MsSUFBcEMsRUFBMENDLE9BQTFDLEVBQW1EO0FBQ3hELE1BQUk7QUFDRkMsSUFBQUEsT0FBTyxDQUFDLGNBQUQsQ0FBUCxDQUF3QkMsSUFBeEIsQ0FBNkJGLE9BQTdCLEVBQXFDLDRCQUFyQzs7QUFDQSxVQUFNRyxJQUFJLEdBQUdGLE9BQU8sQ0FBQyxNQUFELENBQXBCOztBQUNBLFFBQUk7QUFBRUcsTUFBQUEsS0FBRjtB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SDtBQUNELEtBTEQsTUFNSztBQUNIdEQsTUFBQUEsSUFBSSxDQUFDcUQsT0FBTCxHQUFlLEtBQWY7QUFDRDs7QUFDRHJELElBQUFBLElBQUksQ0FBQ29ELFlBQUwsR0FBb0JULGVBQXBCO0FBQ0QsR0FwQ0QsQ0FxQ0EsT0FBTTFCLENBQU4sRUFBUztBQUNQQyxJQUFBQSxPQUFPLENBQUNDLEdBQVIsQ0FBWUYsQ0FBWjtBQUNBbEIsSUFBQUEsV0FBVyxDQUFDcUIsTUFBWixDQUFtQkMsSUFBbkIsQ0FBd0IsdUJBQXVCSixDQUEvQztBQUNEO0FBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIlxuXG5leHBvcnQgZnVuY3Rpb24gX2FmdGVyQ29tcGlsZShjb21waWxhdGlvbiwgdmFycywgb3B0aW9ucykge1xuICB0cnkge1xuICAgIHJlcXVpcmUoJy4vcGx1Z2luVXRpbCcpLmxvZ3Yob3B0aW9ucywnRlVOQ1RJT04gZXh0LWFmdGVyLWNvbXBpbGUnKVxuICAgIGNvbnN0IHBhdGggPSByZXF1aXJlKCdwYXRoJylcbiAgICBsZXQgeyBmaWxlcywgZGlycyB9ID0gdmFyc1xuICAgIGNvbnN0IHsgY3dkIH0gPSB2YXJzXG4gICAgZmlsZXMgPSB0eXBlb2YgZmlsZXMgPT09ICdzdHJpbmcnID8gW2ZpbGVzXSA6IGZpbGVzXG4gICAgZGlycyA9IHR5cGVvZiBkaXJzID09PSAnc3RyaW5nJyA/IFtkaXJzXSA6IGRpcnNcbiAgICBjb25zdCB7XG4gICAgICBmaWxlRGVwZW5kZW5jaWVzLFxuICAgICAgY29udGV4dERlcGVuZGVuY2llcyxcbiAgICB9ID0gX2dldEZpbGVBbmRDb250ZXh0RGVwcyhjb21waWxhdGlvbiwgZmlsZXMsIGRpcnMsIGN3ZCwgb3B0aW9ucyk7XG4gICAgaWYgKGZpbGVzLmxlbmd0aCA+IDApIHtcbiAgICAgIGZpbGVEZXBlbmRlbmNpZXMuZm9yRWFjaCgoZmlsZSkgPT4ge1xuICAgICAgICBjb21waWxhdGlvbi5maWxlRGVwZW5kZW5jaWVzLmFkZChwYXRoLnJlc29sdmUoZmlsZSkpO1xuICAgICAgfSlcbiAgICB9XG4gICAgaWYgKGRpcnMubGVuZ3RoID4gMCkge1xuICAgICAgY29udGV4dERlcGVuZGVuY2llcy5mb3JFYWNoKChjb250ZXh0KSA9PiB7XG4gICAgICAgIGNvbXBpbGF0aW9uLmNvbnRleHREZXBlbmRlbmNpZXMuYWRkKGNvbnRleHQpO1xuICAgICAgfSlcbiAgICB9XG4gIH1cbiAgY2F0Y2goZSkge1xuICAgIGNvbnNvbGUubG9nKGUpXG4gICAgY29tcGlsYXRpb24uZXJyb3JzLnB1c2goJ19hZnRlckNvbXBpbGU6ICcgKyBlKVxuICB9XG59XG5cbmZ1bmN0aW9uIF9nZXRGaWxlQW5kQ29udGV4dERlcHMoY29tcGlsYXRpb24sIGZpbGVzLCBkaXJzLCBjd2QsIG9wdGlvbnMpIHtcbiAgcmVxdWlyZSgnLi9wbHVnaW5VdGlsJykubG9ndihvcHRpb25zLCdGVU5DVElPTiBfZ2V0RmlsZUFuZENvbnRleHREZXBzJylcbiAgY29uc3QgdW5pcSA9IHJlcXVpcmUoJ2xvZGFzaC51bmlxJylcbiAgY29uc3QgaXNHbG9iID0gcmVxdWlyZSgnaXMtZ2xvYicpXG5cbiAgY29uc3QgeyBmaWxlRGVwZW5kZW5jaWVzLCBjb250ZXh0RGVwZW5kZW5jaWVzIH0gPSBjb21waWxhdGlvbjtcbiAgY29uc3QgaXNXZWJwYWNrNCA9IGNvbXBpbGF0aW9uLmhvb2tzO1xuICBsZXQgZmRzID0gaXNXZWJwYWNrNCA/IFsuLi5maWxlRGVwZW5kZW5jaWVzXSA6IGZpbGVEZXBlbmRlbmNpZXM7XG4gIGxldCBjZHMgPSBpc1dlYnBhY2s0ID8gWy4uLmNvbnRleHREZXBlbmRlbmNpZXNdIDogY29udGV4dERlcGVuZGVuY2llcztcbiAgaWYgKGZpbGVzLmxlbmd0aCA+IDApIHtcbiAgICBmaWxlcy5mb3JFYWNoKChwYXR0ZXJuKSA9PiB7XG4gICAgICBsZXQgZiA9IHBhdHRlcm5cbiAgICAgIGlmIChpc0dsb2IocGF0dGVybikpIHtcbiAgICAgICAgZiA9IGdsb2Iuc3luYyhwYXR0ZXJuLCB7IGN3ZCwgZG90OiB0cnVlLCBhYnNvbHV0ZTogdHJ1ZSB9KVxuICAgICAgfVxuICAgICAgZmRzID0gZmRzLmNvbmNhdChmKVxuICAgIH0pXG4gICAgZmRzID0gdW5pcShmZHMpXG4gIH1cbiAgaWYgKGRpcnMubGVuZ3RoID4gMCkge1xuICAgIGNkcyA9IHVuaXEoY2RzLmNvbmNhdChkaXJzKSlcbiAgfVxuICByZXR1cm4geyBmaWxlRGVwZW5kZW5jaWVzOiBmZHMsIGNvbnRleHREZXBlbmRlbmNpZXM6IGNkcyB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBfcHJlcGFyZUZvckJ1aWxkKGFwcCwgdmFycywgb3B0aW9ucywgb3V0cHV0LCBjb21waWxhdGlvbikge1xuICB0cnkge1xuICAgIGNvbnN0IGxvZyA9IHJlcXVpcmUoJy4vcGx1Z2luVXRpbCcpLmxvZ1xuICAgIGNvbnN0IGxvZ3YgPSByZXF1aXJlKCcuL3BsdWdpblV0aWwnKS5sb2d2XG4gICAgbG9ndihvcHRpb25zLCdfcHJlcGFyZUZvckJ1aWxkJylcbiAgICBjb25zdCBmcyA9IHJlcXVpcmUoJ2ZzJylcbiAgICBjb25zdCByZWN1cnNpdmVSZWFkU3luYyA9IHJlcXVpcmUoJ3JlY3Vyc2l2ZS1yZWFkZGlyLXN5bmMnKVxuICAgIHZhciB3YXRjaGVkRmlsZXM9W11cbiAgICB0cnkge3dhdGNoZWRGaWxlcyA9IHJlY3Vyc2l2ZVJlYWRTeW5jKCcuL2FwcCcpLmNvbmNhdChyZWN1cnNpdmVSZWFkU3luYygnLi9wYWNrYWdlcycpKX1cbiAgICBjYXRjaChlcnIpIHtpZihlcnIuZXJybm8gPT09IDM0KXtjb25zb2xlLmxvZygnUGF0aCBkb2VzIG5vdCBleGlzdCcpO30gZWxzZSB7dGhyb3cgZXJyO319XG4gICAgdmFyIGN1cnJlbnROdW1GaWxlcyA9IHdhdGNoZWRGaWxlcy5sZW5ndGhcbiAgICBsb2d2KG9wdGlvbnMsJ3dhdGNoZWRGaWxlczogJyArIGN1cnJlbnROdW1GaWxlcylcbiAgICB2YXIgZG9CdWlsZCA9IHRydWVcbiAgICBcbiAgICBsb2d2KG9wdGlvbnMsJ2RvQnVpbGQ6ICcgKyBkb0J1aWxkKVxuXG4gICAgdmFycy5sYXN0TWlsbGlzZWNvbmRzID0gKG5ldyBEYXRlKS5nZXRUaW1lKClcbiAgICB2YXIgZmlsZXNvdXJjZSA9ICd0aGlzIGZpbGUgZW5hYmxlcyBjbGllbnQgcmVsb2FkJ1xuICAgIGNvbXBpbGF0aW9uLmFzc2V0c1tjdXJyZW50TnVtRmlsZXMgKyAnRmlsZXNVbmRlckFwcEZvbGRlci5tZCddID0ge1xuICAgICAgc291cmNlOiBmdW5jdGlvbigpIHtyZXR1cm4gZmlsZXNvdXJjZX0sXG4gICAgICBzaXplOiBmdW5jdGlvbigpIHtyZXR1cm4gZmlsZXNvdXJjZS5sZW5ndGh9XG4gICAgfVxuXG4gICAgbG9ndihvcHRpb25zLCdjdXJyZW50TnVtRmlsZXM6ICcgKyBjdXJyZW50TnVtRmlsZXMpXG4gICAgbG9ndihvcHRpb25zLCd2YXJzLmxhc3ROdW1GaWxlczogJyArIHZhcnMubGFzdE51bUZpbGVzKVxuICAgIGxvZ3Yob3B0aW9ucywnZG9CdWlsZDogJyArIGRvQnVpbGQpXG5cbiAgICBpZiAoY3VycmVudE51bUZpbGVzICE9IHZhcnMubGFzdE51bUZpbGVzIHx8IGRvQnVpbGQpIHtcbiAgICAgIHZhcnMucmVidWlsZCA9IHRydWVcbiAgICAgIHZhciBidW5kbGVEaXIgPSBvdXRwdXQucmVwbGFjZShwcm9jZXNzLmN3ZCgpLCAnJylcbiAgICAgIGlmIChidW5kbGVEaXIudHJpbSgpID09ICcnKSB7YnVuZGxlRGlyID0gJy4vJ31cbiAgICAgIGxvZyhhcHAgKyAnQnVpbGRpbmcgRXh0IGJ1bmRsZSBhdDogJyArIGJ1bmRsZURpcilcbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICB2YXJzLnJlYnVpbGQgPSBmYWxzZVxuICAgIH1cbiAgICB2YXJzLmxhc3ROdW1GaWxlcyA9IGN1cnJlbnROdW1GaWxlc1xuICB9XG4gIGNhdGNoKGUpIHtcbiAgICBjb25zb2xlLmxvZyhlKVxuICAgIGNvbXBpbGF0aW9uLmVycm9ycy5wdXNoKCdfcHJlcGFyZUZvckJ1aWxkOiAnICsgZSlcbiAgfVxufVxuIl19