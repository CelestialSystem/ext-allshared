"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports._getDefaultVars = _getDefaultVars;
exports._extractFromSource = _extractFromSource;
exports._toProd = _toProd;
exports._toDev = _toDev;
exports._getAllComponents = _getAllComponents;
exports._writeFilesToProdFolder = _writeFilesToProdFolder;

function _getDefaultVars() {
  return {
    touchFile: '/src/themer.js',
    watchStarted: false,
    buildstep: '1 of 1',
    firstTime: true,
    firstCompile: true,
    browserCount: 0,
    manifest: null,
    extPath: 'ext',
    pluginErrors: [],
    deps: [],
    usedExtWebComponents: [],
    rebuild: true
  };
}

function _extractFromSource(module, options, compilation, ExtWebComponents) {
  const logv = require('./pluginUtil').logv;

  const verbose = options.verbose;
  logv(verbose, 'FUNCTION _extractFromSource');
  var js = module._source._value;
  logv(verbose, module.resource);
  var statements = [];

  var generate = require("@babel/generator").default;

  var parse = require("babylon").parse;

  var traverse = require("ast-traverse");

  var ast = parse(js, {
    plugins: ['typescript', 'flow', 'doExpressions', 'objectRestSpread', 'classProperties', 'exportDefaultFrom', 'exportExtensions', 'asyncGenerators', 'functionBind', 'functionSent', 'dynamicImport'],
    sourceType: 'module'
  });
  traverse(ast, {
    pre: function (node) {
      if (node.type === 'CallExpression' && node.callee && node.callee.object && node.callee.object.name === 'Ext') {
        statements.push(generate(node).code);
      }

      if (node.type === 'CallExpression') {
        const code = generate(node).code;
        statements = statements.concat(getXtypeFromHTMLJS(code, statements, ExtWebComponents));
      }

      if (node.type === 'StringLiteral') {
        let code = node.value;

        for (var i = 0; i < code.length; ++i) {
          if (code.charAt(i) == '<') {
            if (code.substr(i, 4) == '<!--') {
              i += 4;
              i += code.substr(i).indexOf('-->') + 3;
            } else if (code.charAt(i + 1) !== '/') {
              var start = code.substring(i);
              var end = getEnd(start, [' ', '\n', '>']);
              var xtype = start.substring(1, end);

              if (ExtWebComponents.includes(xtype)) {
                xtype = xtype.substring(4, end);
                var theValue = node.value.toLowerCase();

                if (theValue.indexOf('doctype html') == -1) {
                  var config = `Ext.create(${JSON.stringify({
                    xtype: xtype
                  })})`;

                  if (statements.indexOf(config) < 0) {
                    statements.push(config);
                  }
                }
              }

              i += end;
            }
          }
        }

        statements = statements.concat(getXtypeFromHTMLJS(code, statements, ExtWebComponents));
      }
    }
  });
  return statements;
}

function getXtypeFromHTMLJS(code, statements, ExtWebComponents) {
  const logv = require('./pluginUtil').logv;

  const result = [];
  const xtypeRepetitons = (code.match(/xtype/g) || []).length;

  if (xtypeRepetitons > 0) {
    for (var j = 0; j < xtypeRepetitons; j++) {
      var start = code.substring(code.indexOf('xtype') + 5);
      var ifAsProps = start.indexOf(':');
      var ifAsAttribute = start.indexOf('=');
      start = start.substring(Math.min(ifAsProps, ifAsAttribute) + 1);
      start = start.trim();
      var end = getEnd(start, ['\n', '>', '}', '\r']);
      var xtype = start.substring(1, end).trim().replace(/['",]/g, '');
      var config = `Ext.create(${JSON.stringify({
        xtype: xtype
      })})`;

      if (ExtWebComponents.includes('ext-' + xtype) && statements.indexOf(config) === -1) {
        result.push(config);
      }

      code = start.substr(end).trim();
    }
  }

  return result;
}

function _toProd(vars, options) {
  const logv = require('./pluginUtil').logv;

  logv(options.verbose, 'FUNCTION _toProd (empty');

  try {} catch (e) {
    console.log(e);
    return [];
  }
}

function _toDev(vars, options) {
  try {} catch (e) {
    console.log(e);
    return [];
  }
}

function _getAllComponents(vars, options) {
  const log = require('./pluginUtil').log;

  const logv = require('./pluginUtil').logv;

  logv(options.verbose, 'FUNCTION _getAllComponents');

  const path = require('path');

  const fsx = require('fs-extra'); //    log(vars.app, `Getting all referenced ext-${options.framework} modules`)


  var ExtWebComponents = [];
  const packageLibPath = path.resolve(process.cwd(), 'node_modules/@sencha/ext-web-components/lib');
  var files = fsx.readdirSync(packageLibPath);
  files.forEach(fileName => {
    if (fileName && fileName.substr(0, 4) == 'ext-') {
      var end = fileName.substr(4).indexOf('.component');

      if (end >= 0) {
        ExtWebComponents.push(fileName.substring(0, end + 4));
      }
    }
  });
  log(vars.app, `Writing all referenced ext-${options.framework} modules`);
  return ExtWebComponents;
}

function _writeFilesToProdFolder(vars, options) {
  const logv = require('./pluginUtil').logv;

  logv(options.verbose, 'FUNCTION _writeFilesToProdFolder (empty)');

  try {} catch (e) {
    console.log(e);
  }
}

function getEnd(start, setOfSymbolsToCheck) {
  var endingsArr = [];

  for (var i = 0; i < setOfSymbolsToCheck.length; i++) {
    var symbolIndex = start.indexOf(setOfSymbolsToCheck[i]);

    if (symbolIndex !== -1) {
      endingsArr.push(symbolIndex);
    }
  }

  return Math.min(...endingsArr);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy93ZWJjb21wb25lbnRzVXRpbC5qcyJdLCJuYW1lcyI6WyJfZ2V0RGVmYXVsdFZhcnMiLCJ0b3VjaEZpbGUiLCJ3YXRjaFN0YXJ0ZWQiLCJidWlsZHN0ZXAiLCJmaXJzdFRpbWUiLCJmaXJzdENvbXBpbGUiLCJicm93c2VyQ291bnQiLCJtYW5pZmVzdCIsImV4dFBhdGgiLCJwbHVnaW5FcnJvcnMiLCJkZXBzIiwidXNlZEV4dFdlYkNvbXBvbmVudHMiLCJyZWJ1aWxkIiwiX2V4dHJhY3RGcm9tU291cmNlIiwibW9kdWxlIiwib3B0aW9ucyIsImNvbXBpbGF0aW9uIiwiRXh0V2ViQ29tcG9uZW50cyIsImxvZ3YiLCJyZXF1aXJlIiwidmVyYm9zZSIsImpzIiwiX3NvdXJjZSIsIl92YWx1ZSIsInJlc291cmNlIiwic3RhdGVtZW50cyIsImdlbmVyYXRlIiwiZGVmYXVsdCIsInBhcnNlIiwidHJhdmVyc2UiLCJhc3QiLCJwbHVnaW5zIiwic291cmNlVHlwZSIsInByZSIsIm5vZGUiLCJ0eXBlIiwiY2FsbGVlIiwib2JqZWN0IiwibmFtZSIsInB1c2giLCJjb2RlIiwiY29uY2F0IiwiZ2V0WHR5cGVGcm9tSFRNTEpTIiwidmFsdWUiLCJpIiwibGVuZ3RoIiwiY2hhckF0Iiwic3Vic3RyIiwiaW5kZXhPZiIsInN0YXJ0Iiwic3Vic3RyaW5nIiwiZW5kIiwiZ2V0RW5kIiwieHR5cGUiLCJpbmNsdWRlcyIsInRoZVZhbHVlIiwidG9Mb3dlckNhc2UiLCJjb25maWciLCJKU09OIiwic3RyaW5naWZ5IiwicmVzdWx0IiwieHR5cGVSZXBldGl0b25zIiwibWF0Y2giLCJqIiwiaWZBc1Byb3BzIiwiaWZBc0F0dHJpYnV0ZSIsIk1hdGgiLCJtaW4iLCJ0cmltIiwicmVwbGFjZSIsIl90b1Byb2QiLCJ2YXJzIiwiZSIsImNvbnNvbGUiLCJsb2ciLCJfdG9EZXYiLCJfZ2V0QWxsQ29tcG9uZW50cyIsInBhdGgiLCJmc3giLCJwYWNrYWdlTGliUGF0aCIsInJlc29sdmUiLCJwcm9jZXNzIiwiY3dkIiwiZmlsZXMiLCJyZWFkZGlyU3luYyIsImZvckVhY2giLCJmaWxlTmFtZSIsImFwcCIsImZyYW1ld29yayIsIl93cml0ZUZpbGVzVG9Qcm9kRm9sZGVyIiwic2V0T2ZTeW1ib2xzVG9DaGVjayIsImVuZGluZ3NBcnIiLCJzeW1ib2xJbmRleCJdLCJtYXBwaW5ncyI6IkFBQ0E7Ozs7Ozs7Ozs7OztBQUVPLFNBQVNBLGVBQVQsR0FBMkI7QUFDaEMsU0FBTztBQUNMQyxJQUFBQSxTQUFTLEVBQUUsZ0JBRE47QUFFTEMsSUFBQUEsWUFBWSxFQUFHLEtBRlY7QUFHTEMsSUFBQUEsU0FBUyxFQUFFLFFBSE47QUFJTEMsSUFBQUEsU0FBUyxFQUFHLElBSlA7QUFLTEMsSUFBQUEsWUFBWSxFQUFFLElBTFQ7QUFNTEMsSUFBQUEsWUFBWSxFQUFHLENBTlY7QUFPTEMsSUFBQUEsUUFBUSxFQUFFLElBUEw7QUFRTEMsSUFBQUEsT0FBTyxFQUFFLEtBUko7QUFTTEMsSUFBQUEsWUFBWSxFQUFFLEVBVFQ7QUFVTEMsSUFBQUEsSUFBSSxFQUFFLEVBVkQ7QUFXTEMsSUFBQUEsb0JBQW9CLEVBQUUsRUFYakI7QUFZTEMsSUFBQUEsT0FBTyxFQUFFO0FBWkosR0FBUDtBQWNEOztBQUVNLFNBQVNDLGtCQUFULENBQTRCQyxNQUE1QixFQUFvQ0MsT0FBcEMsRUFBNkNDLFdBQTdDLEVBQTBEQyxnQkFBMUQsRUFBNEU7QUFDakYsUUFBTUMsSUFBSSxHQUFHQyxPQUFPLENBQUMsY0FBRCxDQUFQLENBQXdCRCxJQUFyQzs7QUFDQSxRQUFNRSxPQUFPLEdBQUdMLE9BQU8sQ0FBQ0ssT0FBeEI7QUFDQUYsRUFBQUEsSUFBSSxDQUFDRSxPQUFELEVBQVMsNkJBQVQsQ0FBSjtBQUNBLE1BQUlDLEVBQUUsR0FBR1AsTUFBTSxDQUFDUSxPQUFQLENBQWVDLE1BQXhCO0FBQ0FMLEVBQUFBLElBQUksQ0FBQ0UsT0FBRCxFQUFTTixNQUFNLENBQUNVLFFBQWhCLENBQUo7QUFDQSxNQUFJQyxVQUFVLEdBQUcs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QUFOLENBQWMwQyxtQkFBbUIsQ0FBQzlDLENBQUQsQ0FBakMsQ0FBbEI7O0FBRUEsUUFBSWdELFdBQVcsS0FBSyxDQUFDLENBQXJCLEVBQXdCO0FBQ3RCRCxNQUFBQSxVQUFVLENBQUNwRCxJQUFYLENBQWdCcUQsV0FBaEI7QUFDRDtBQUNIOztBQUNELFNBQU8xQixJQUFJLENBQUNDLEdBQUwsQ0FBUyxHQUFHd0IsVUFBWixDQUFQO0FBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJcblwidXNlIHN0cmljdFwiXG5cbmV4cG9ydCBmdW5jdGlvbiBfZ2V0RGVmYXVsdFZhcnMoKSB7XG4gIHJldHVybiB7XG4gICAgdG91Y2hGaWxlOiAnL3NyYy90aGVtZXIuanMnLFxuICAgIHdhdGNoU3RhcnRlZCA6IGZhbHNlLFxuICAgIGJ1aWxkc3RlcDogJzEgb2YgMScsXG4gICAgZmlyc3RUaW1lIDogdHJ1ZSxcbiAgICBmaXJzdENvbXBpbGU6IHRydWUsXG4gICAgYnJvd3NlckNvdW50IDogMCxcbiAgICBtYW5pZmVzdDogbnVsbCxcbiAgICBleHRQYXRoOiAnZXh0JyxcbiAgICBwbHVnaW5FcnJvcnM6IFtdLFxuICAgIGRlcHM6IFtdLFxuICAgIHVzZWRFeHRXZWJDb21wb25lbnRzOiBbXSxcbiAgICByZWJ1aWxkOiB0cnVlXG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIF9leHRyYWN0RnJvbVNvdXJjZShtb2R1bGUsIG9wdGlvbnMsIGNvbXBpbGF0aW9uLCBFeHRXZWJDb21wb25lbnRzKSB7XG4gIGNvbnN0IGxvZ3YgPSByZXF1aXJlKCcuL3BsdWdpblV0aWwnKS5sb2d2XG4gIGNvbnN0IHZlcmJvc2UgPSBvcHRpb25zLnZlcmJvc2VcbiAgbG9ndih2ZXJib3NlLCdGVU5DVElPTiBfZXh0cmFjdEZyb21Tb3VyY2UnKVxuICB2YXIganMgPSBtb2R1bGUuX3NvdXJjZS5fdmFsdWVcbiAgbG9ndih2ZXJib3NlLG1vZHVsZS5yZXNvdXJjZSlcbiAgdmFyIHN0YXRlbWVudHMgPSBbXVxuXG4gIHZhciBnZW5lcmF0ZSA9IHJlcXVpcmUoXCJAYmFiZWwvZ2VuZXJhdG9yXCIpLmRlZmF1bHRcbiAgdmFyIHBhcnNlID0gcmVxdWlyZShcImJhYnlsb25cIikucGFyc2VcbiAgdmFyIHRyYXZlcnNlID0gcmVxdWlyZShcImFzdC10cmF2ZXJzZVwiKVxuXG4gIHZhciBhc3QgPSBwYXJzZShqcywge1xuICAgIHBsdWdpbnM6IFtcbiAgICAgICd0eXBlc2NyaXB0JyxcbiAgICAgICdmbG93JyxcbiAgICAgICdkb0V4cHJlc3Npb25zJyxcbiAgICAgICdvYmplY3RSZXN0U3ByZWFkJyxcbiAgICAgICdjbGFzc1Byb3BlcnRpZXMnLFxuICAgICAgJ2V4cG9ydERlZmF1bHRGcm9tJyxcbiAgICAgICdleHBvcnRFeHRlbnNpb25zJyxcbiAgICAgICdhc3luY0dlbmVyYXRvcnMnLFxuICAgICAgJ2Z1bmN0aW9uQmluZCcsXG4gICAgICAnZnVuY3Rpb25TZW50JyxcbiAgICAgICdkeW5hbWljSW1wb3J0J1xuICAgIF0sXG4gICAgc291cmNlVHlwZTogJ21vZHVsZSdcbiAgfSlcblxuICB0cmF2ZXJzZShhc3QsIHtcbiAgICBwcmU6IGZ1bmN0aW9uIChub2RlKSB7XG4gICAgICBpZiAobm9kZS50eXBlID09PSAnQ2FsbEV4cHJlc3Npb24nICYmIG5vZGUuY2FsbGVlICYmIG5vZGUuY2FsbGVlLm9iamVjdCAmJiBub2RlLmNhbGxlZS5vYmplY3QubmFtZSA9PT0gJ0V4dCcpIHtcbiAgICAgICAgc3RhdGVtZW50cy5wdXNoKGdlbmVyYXRlKG5vZGUpLmNvZGUpXG4gICAgICB9XG4gICAgICBpZiAobm9kZS50eXBlID09PSAnQ2FsbEV4cHJlc3Npb24nKSB7XG4gICAgICAgIGNvbnN0IGNvZGUgPSBnZW5lcmF0ZShub2RlKS5jb2RlO1xuICAgICAgICBzdGF0ZW1lbnRzID0gc3RhdGVtZW50cy5jb25jYXQoZ2V0WHR5cGVGcm9tSFRNTEpTKGNvZGUsIHN0YXRlbWVudHMsIEV4dFdlYkNvbXBvbmVudHMpKTtcbiAgICAgIH1cbiAgICAgIGlmKG5vZGUudHlwZSA9PT0gJ1N0cmluZ0xpdGVyYWwnKSB7XG4gICAgICAgIGxldCBjb2RlID0gbm9kZS52YWx1ZVxuICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNvZGUubGVuZ3RoOyArK2kpIHtcbiAgICAgICAgICBpZiAoY29kZS5jaGFyQXQoaSkgPT0gJzwnKSB7XG4gICAgICAgICAgICBpZiAoY29kZS5zdWJzdHIoaSwgNCkgPT0gJzwhLS0nKSB7XG4gICAgICAgICAgICAgIGkgKz0gNFxuICAgICAgICAgICAgICBpICs9IGNvZGUuc3Vic3RyKGkpLmluZGV4T2YoJy0tPicpICsgM1xuICAgICAgICAgICAgfSBlbHNlIGlmIChjb2RlLmNoYXJBdChpKzEpICE9PSAnLycpIHtcbiAgICAgICAgICAgICAgdmFyIHN0YXJ0ID0gY29kZS5zdWJzdHJpbmcoaSlcbiAgICAgICAgICAgICAgdmFyIGVuZCA9IGdldEVuZChzdGFydCwgWycgJywgJ1xcbicsICc+J10pO1xuXG4gICAgICAgICAgICAgICAgdmFyIHh0eXBlID0gc3RhcnQuc3Vic3RyaW5nKDEsIGVuZClcbiAgICAgICAgICAgICAgICBpZihFeHRXZWJDb21wb25lbnRzLmluY2x1ZGVzKHh0eXBlKSkge1xuICAgICAgICAgICAgICAgICAgeHR5cGUgPSB4dHlwZS5zdWJzdHJpbmcoNCwgZW5kKTtcbiAgICAgICAgICAgICAgICAgIHZhciB0aGVWYWx1ZSA9IG5vZGUudmFsdWUudG9Mb3dlckNhc2UoKVxuICAgICAgICAgICAgICAgICAgaWYgKHRoZVZhbHVlLmluZGV4T2YoJ2RvY3R5cGUgaHRtbCcpID09IC0xKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBjb25maWcgPSBgRXh0LmNyZWF0ZSgke0pTT04uc3RyaW5naWZ5KHt4dHlwZTogeHR5cGV9KX0pYDtcblxuICAgICAgICAgICAgICAgICAgICBpZiAoc3RhdGVtZW50cy5pbmRleE9mKGNvbmZpZykgPCAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgc3RhdGVtZW50cy5wdXNoKGNvbmZpZyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaSArPSBlbmRcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cblxuICAgICAgICAgIHN0YXRlbWVudHMgPSBzdGF0ZW1lbnRzLmNvbmNhdChnZXRYdHlwZUZyb21IVE1MSlMoY29kZSwgc3RhdGVtZW50cywgRXh0V2ViQ29tcG9uZW50cykpO1xuICAgICAgICB9XG4gICAgICB9XG4gIH0pO1xuXG4gIHJldHVybiBzdGF0ZW1lbnRzXG59XG5cbmZ1bmN0aW9uIGdldFh0eXBlRnJvbUhUTUxKUyhjb2RlLCBzdGF0ZW1lbnRzLCBFeHRXZWJDb21wb25lbnRzKSB7XG4gIGNvbnN0IGxvZ3YgPSByZXF1aXJlKCcuL3BsdWdpblV0aWwnKS5sb2d2XG4gIGNvbnN0IHJlc3VsdCA9IFtdO1xuICBjb25zdCB4dHlwZVJlcGV0aXRvbnMgPSAoY29kZS5tYXRjaCgveHR5cGUvZykgfHwgW10pLmxlbmd0aDtcblxuICBpZiAoeHR5cGVSZXBldGl0b25zID4gMCkge1xuICAgIGZvciAodmFyIGo9MDsgajx4dHlwZVJlcGV0aXRvbnM7IGorKykge1xuICAgICAgdmFyIHN0YXJ0ID0gY29kZS5zdWJzdHJpbmcoY29kZS5pbmRleE9mKCd4dHlwZScpICsgNSk7XG4gICAgICB2YXIgaWZBc1Byb3BzID0gc3RhcnQuaW5kZXhPZignOicpO1xuICAgICAgdmFyIGlmQXNBdHRyaWJ1dGUgPSBzdGFydC5pbmRleE9mKCc9Jyk7XG4gICAgICBzdGFydCA9IHN0YXJ0LnN1YnN0cmluZyhNYXRoLm1pbihpZkFzUHJvcHMsIGlmQXNBdHRyaWJ1dGUpICsgMSk7XG4gICAgICBzdGFydCA9IHN0YXJ0LnRyaW0oKTtcbiAgICAgIHZhciBlbmQgPSBnZXRFbmQoc3RhcnQsIFsnXFxuJywgJz4nLCd9JywgJ1xcciddKVxuICAgICAgdmFyIHh0eXBlID0gc3RhcnQuc3Vic3RyaW5nKDEsIGVuZCkudHJpbSgpLnJlcGxhY2UoL1snXCIsXS9nLCAnJyk7XG5cbiAgICAgIHZhciBjb25maWcgPSBgRXh0LmNyZWF0ZSgke0pTT04uc3RyaW5naWZ5KHt4dHlwZTogeHR5cGV9KX0pYDtcbiAgICAgIGlmKEV4dFdlYkNvbXBvbmVudHMuaW5jbHVkZXMoJ2V4dC0nICsgeHR5cGUpICYmIHN0YXRlbWVudHMuaW5kZXhPZihjb25maWcpID09PSAtMSkge1xuICAgICAgICByZXN1bHQucHVzaChjb25maWcpO1xuICAgICAgfVxuICAgICAgY29kZSA9IHN0YXJ0LnN1YnN0cihlbmQpLnRyaW0oKTtcbiAgICB9XG4gIH1cblxuICByZXR1cm4gcmVzdWx0O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gX3RvUHJvZCh2YXJzLCBvcHRpb25zKSB7XG4gIGNvbnN0IGxvZ3YgPSByZXF1aXJlKCcuL3BsdWdpblV0aWwnKS5sb2d2XG4gIGxvZ3Yob3B0aW9ucy52ZXJib3NlLCdGVU5DVElPTiBfdG9Qcm9kIChlbXB0eScpXG4gIHRyeSB7XG4gIH1cbiAgY2F0Y2ggKGUpIHtcbiAgICBjb25zb2xlLmxvZyhlKVxuICAgIHJldHVybiBbXVxuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBfdG9EZXYodmFycywgb3B0aW9ucykge1xuICB0cnkge1xuICB9XG4gIGNhdGNoIChlKSB7XG4gICAgY29uc29sZS5sb2coZSlcbiAgICByZXR1cm4gW11cbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gX2dldEFsbENvbXBvbmVudHModmFycywgb3B0aW9ucykge1xuICBjb25zdCBsb2cgPSByZXF1aXJlKCcuL3BsdWdpblV0aWwnKS5sb2dcbiAgY29uc3QgbG9ndiA9IHJlcXVpcmUoJy4vcGx1Z2luVXRpbCcpLmxvZ3ZcbiAgbG9ndihvcHRpb25zLnZlcmJvc2UsJ0ZVTkNUSU9OIF9nZXRBbGxDb21wb25lbnRzJylcblxuICBjb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpXG4gIGNvbnN0IGZzeCA9IHJlcXVpcmUoJ2ZzLWV4dHJhJylcblxuLy8gICAgbG9nKHZhcnMuYXBwLCBgR2V0dGluZyBhbGwgcmVmZXJlbmNlZCBleHQtJHtvcHRpb25zLmZyYW1ld29ya30gbW9kdWxlc2ApXG4gIHZhciBFeHRXZWJDb21wb25lbnRzID0gW11cbiAgY29uc3QgcGFja2FnZUxpYlBhdGggPSBwYXRoLnJlc29sdmUocHJvY2Vzcy5jd2QoKSwgJ25vZGVfbW9kdWxlcy9Ac2VuY2hhL2V4dC13ZWItY29tcG9uZW50cy9saWInKVxuICB2YXIgZmlsZXMgPSBmc3gucmVhZGRpclN5bmMocGFja2FnZUxpYlBhdGgpXG4gIGZpbGVzLmZvckVhY2goKGZpbGVOYW1lKSA9PiB7XG4gICAgaWYgKGZpbGVOYW1lICYmIGZpbGVOYW1lLnN1YnN0cigwLCA0KSA9PSAnZXh0LScpIHtcbiAgICAgIHZhciBlbmQgPSBmaWxlTmFtZS5zdWJzdHIoNCkuaW5kZXhPZignLmNvbXBvbmVudCcpXG4gICAgICBpZiAoZW5kID49IDApIHtcbiAgICAgICAgRXh0V2ViQ29tcG9uZW50cy5wdXNoKGZpbGVOYW1lLnN1YnN0cmluZygwLCBlbmQgKyA0KSlcbiAgICAgIH1cbiAgICB9XG4gIH0pXG4gIGxvZyh2YXJzLmFwcCwgYFdyaXRpbmcgYWxsIHJlZmVyZW5jZWQgZXh0LSR7b3B0aW9ucy5mcmFtZXdvcmt9IG1vZHVsZXNgKVxuICByZXR1cm4gRXh0V2ViQ29tcG9uZW50c1xufVxuXG5leHBvcnQgZnVuY3Rpb24gX3dyaXRlRmlsZXNUb1Byb2RGb2xkZXIodmFycywgb3B0aW9ucykge1xuICBjb25zdCBsb2d2ID0gcmVxdWlyZSgnLi9wbHVnaW5VdGlsJykubG9ndlxuICBsb2d2KG9wdGlvbnMudmVyYm9zZSwnRlVOQ1RJT04gX3dyaXRlRmlsZXNUb1Byb2RGb2xkZXIgKGVtcHR5KScpXG4gIHRyeSB7XG4gIH1cbiAgY2F0Y2ggKGUpIHtcbiAgICBjb25zb2xlLmxvZyhlKVxuICB9XG59XG5cbmZ1bmN0aW9uIGdldEVuZChzdGFydCwgc2V0T2ZTeW1ib2xzVG9DaGVjaykge1xuICB2YXIgZW5kaW5nc0FyciA9IFtdO1xuXG4gIGZvciAodmFyIGk9MDtpPHNldE9mU3ltYm9sc1RvQ2hlY2subGVuZ3RoO2krKykge1xuICAgICB2YXIgc3ltYm9sSW5kZXggPSBzdGFydC5pbmRleE9mKHNldE9mU3ltYm9sc1RvQ2hlY2tbaV0pO1xuXG4gICAgIGlmIChzeW1ib2xJbmRleCAhPT0gLTEpIHtcbiAgICAgICBlbmRpbmdzQXJyLnB1c2goc3ltYm9sSW5kZXgpO1xuICAgICB9XG4gIH1cbiAgcmV0dXJuIE1hdGgubWluKC4uLmVuZGluZ3NBcnIpXG59XG4iXX0=